<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TTX Gym - Scenario Builder</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link rel="stylesheet" href="style.css">
  <style>
    /* ─── EDITOR LAYOUT ─── */
    #editor-wrap {
      flex: 1;
      display: flex;
      overflow: hidden;
      height: calc(100vh - 56px);
    }

    /* ─── LEFT PANEL ─── */
    #editor-panel {
      width: 52%;
      min-width: 380px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      overflow: hidden;
    }

    #editor-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      height: 52px;
      border-bottom: 1px solid var(--border);
      background: var(--mid);
      flex-shrink: 0;
      gap: 1rem;
    }

    #editor-topbar h1 {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    .topbar-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    #editor-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    /* TTXF syntax accent colours — mirrored from preview panel */
    :root {
      --ttxf-directive: var(--amber);
      /* ! metadata fields    */
      --ttxf-directive-glow: rgba(245, 166, 35, 0.10);
      --ttxf-directive-border: rgba(245, 166, 35, 0.25);
      --ttxf-stage: var(--accent);
      /* @ stage              */
      --ttxf-stage-glow: var(--accent-glow);
      --ttxf-stage-border: var(--border-active);
      --ttxf-array: var(--green);
      /* # discussion/prompts */
      --ttxf-array-glow: var(--green-glow);
      --ttxf-array-border: rgba(62, 201, 200, 0.3);
      --ttxf-question: #c792ea;
      /* ? questions          */
      --ttxf-question-glow: rgba(199, 146, 234, 0.12);
      --ttxf-question-border: rgba(199, 146, 234, 0.3);
    }

    /* ─── FORM FIELDS ─── */
    .field-group {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    /* Moniker prefix shown before each label — maps to TTXF sigil */
    .field-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      padding-left: 2px;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .field-label .sigil {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0;
      opacity: 0.9;
    }

    /* Metadata block (title / author / summary / conclusion) → amber ! */
    .field-group.meta .field-label {
      color: var(--ttxf-directive);
    }

    .field-group.meta .field-label .sigil {
      color: var(--ttxf-directive);
    }

    .field-group.meta .field-input {
      border-color: var(--ttxf-directive-border);
      background: color-mix(in srgb, var(--surface) 92%, var(--amber) 8%);
    }

    .field-group.meta .field-input:focus {
      border-color: var(--ttxf-directive);
      box-shadow: 0 0 0 3px var(--ttxf-directive-glow);
    }

    .field-input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: var(--font-display);
      font-size: 13.5px;
      padding: 0.6rem 0.85rem;
      transition: border-color 0.18s, box-shadow 0.18s;
      outline: none;
    }

    .field-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .field-input::placeholder {
      color: var(--text-muted);
    }

    textarea.field-input {
      min-height: 80px;
      resize: vertical;
      font-family: var(--font-mono);
      font-size: 12.5px;
      line-height: 1.6;
    }

    /* ─── SECTION HEADER ─── */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .section-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--ttxf-stage);
      padding: 0.5rem 0.25rem 0.4rem;
      border-top: 1px solid rgba(46, 125, 224, 0.2);
      flex: 1;
    }

    /* ─── STAGE CARDS  (@) ─── */
    #stages-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .stage-card {
      background: var(--mid);
      border: 1px solid var(--ttxf-stage-border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .stage-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.15s;
      gap: 0.75rem;
      background: rgba(46, 125, 224, 0.05);
    }

    .stage-card-header:hover {
      background: rgba(46, 125, 224, 0.1);
    }

    .stage-card-left {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      min-width: 0;
      flex: 1;
    }

    .stage-num-badge {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 99px;
      background: var(--ttxf-stage-glow);
      color: var(--ttxf-stage);
      flex-shrink: 0;
      border: 1px solid var(--ttxf-stage-border);
      letter-spacing: 0.04em;
    }

    /* @ sigil prefix on stage badge */
    .stage-num-badge::before {
      content: '@ ';
      opacity: 0.6;
    }

    .stage-card-title-input {
      background: none;
      border: none;
      outline: none;
      font-family: var(--font-display);
      font-size: 13.5px;
      font-weight: 600;
      color: var(--text-primary);
      width: 100%;
      min-width: 0;
      cursor: text;
    }

    .stage-card-title-input::placeholder {
      color: rgba(46, 125, 224, 0.35);
      font-weight: 400;
    }

    .stage-card-actions {
      display: flex;
      gap: 0.25rem;
      align-items: center;
      flex-shrink: 0;
    }

    .icon-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.25rem 0.4rem;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      font-size: 14px;
    }

    .icon-btn svg {
      width: 15px;
      height: 15px;
      fill: currentColor;
    }

    .icon-btn:hover {
      background: var(--ttxf-stage-glow);
      color: var(--ttxf-stage);
    }

    .icon-btn.danger:hover {
      color: var(--red);
      background: rgba(224, 82, 82, 0.1);
    }

    .stage-card-body {
      height: 0;
      overflow: hidden;
      transition: height 0.28s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stage-card-inner {
      padding: 0 1rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.85rem;
      border-top: 1px solid var(--ttxf-stage-border);
    }

    /* Stage content field inside a card */
    .stage-card-inner .field-group:first-child .field-label {
      color: var(--ttxf-stage);
    }

    /* ─── ARRAY SECTION LABELS  (#) ─── */
    .array-section-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--ttxf-array);
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding-left: 1px;
      margin-bottom: 0.1rem;
    }

    .array-section-label .sigil {
      opacity: 0.7;
      font-size: 12px;
    }

    /* ─── ARRAY FIELDS (discussion points, prompts, answers) ─── */
    .array-field {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .array-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .array-item .field-input {
      flex: 1;
      min-height: unset;
      resize: none;
      padding: 0.45rem 0.75rem;
    }

    /* Discussion inputs — green tint */
    .discussion-field .array-item .field-input {
      border-color: var(--ttxf-array-border);
      background: color-mix(in srgb, var(--surface) 93%, var(--green) 7%);
    }

    .discussion-field .array-item .field-input:focus {
      border-color: var(--ttxf-array);
      box-shadow: 0 0 0 3px var(--ttxf-array-glow);
    }

    /* Prompt inputs — amber tint */
    .prompts-field .array-item .field-input {
      border-color: var(--ttxf-directive-border);
      background: color-mix(in srgb, var(--surface) 93%, var(--amber) 7%);
    }

    .prompts-field .array-item .field-input:focus {
      border-color: var(--ttxf-directive);
      box-shadow: 0 0 0 3px var(--ttxf-directive-glow);
    }

    .array-item-remove {
      flex-shrink: 0;
      margin-top: 6px;
    }

    .add-item-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-muted);
      cursor: pointer;
      padding: 0.3rem 0.5rem;
      border-radius: var(--radius);
      transition: all 0.15s;
      background: none;
      border: 1px dashed var(--border);
      width: 100%;
      justify-content: center;
    }

    .add-item-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    /* Green add buttons for discussion/prompts */
    .add-discussion-btn:hover {
      border-color: var(--ttxf-array);
      color: var(--ttxf-array);
      background: var(--ttxf-array-glow);
    }

    .add-prompt-btn:hover {
      border-color: var(--ttxf-directive);
      color: var(--ttxf-directive);
      background: var(--ttxf-directive-glow);
    }

    /* ─── QUESTIONS  (?) ─── */
    .questions-section {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .question-section-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--ttxf-question);
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding-left: 1px;
      margin-bottom: 0.1rem;
    }

    .question-section-label .sigil {
      opacity: 0.7;
      font-size: 12px;
    }

    .question-card {
      background: color-mix(in srgb, var(--surface) 90%, #c792ea 10%);
      border: 1px solid var(--ttxf-question-border);
      border-radius: var(--radius);
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .question-card-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .q-type-toggle {
      display: flex;
      background: var(--surface-raised);
      border-radius: 99px;
      border: 1px solid var(--ttxf-question-border);
      overflow: hidden;
      flex-shrink: 0;
    }

    .q-type-toggle button {
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.05em;
      padding: 0.2rem 0.6rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .q-type-toggle button.active {
      background: var(--ttxf-question-glow);
      color: var(--ttxf-question);
    }

    .q-type-toggle button.active.quiz-type {
      background: var(--green-glow);
      color: var(--green);
    }

    /* Question text input */
    .question-card .field-input {
      border-color: var(--ttxf-question-border);
      background: color-mix(in srgb, var(--surface) 94%, #c792ea 6%);
    }

    .question-card .field-input:focus {
      border-color: var(--ttxf-question);
      box-shadow: 0 0 0 3px var(--ttxf-question-glow);
    }

    .answers-list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .answer-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .answer-correct-toggle {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: none;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .answer-correct-toggle.correct {
      border-color: var(--green);
      background: var(--green-glow);
    }

    .answer-correct-toggle.correct::after {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--green);
      border-radius: 50%;
      display: block;
    }

    .answer-item .field-input {
      flex: 1;
      padding: 0.35rem 0.65rem;
      font-size: 12px;
    }

    /* ++ correct answer input */
    .answer-item:has(.answer-correct-toggle.correct) .field-input {
      border-color: var(--ttxf-array-border);
      color: var(--ttxf-array);
    }

    .add-question-btn:hover {
      border-color: var(--ttxf-question);
      color: var(--ttxf-question);
      background: var(--ttxf-question-glow);
    }

    /* ─── BUTTONS ─── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.45rem 0.9rem;
      border-radius: var(--radius);
      font-family: var(--font-display);
      font-size: 12.5px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .btn svg {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-ghost {
      background: var(--surface);
      color: var(--text-secondary);
      border-color: var(--border);
    }

    .btn-ghost:hover {
      background: var(--surface-raised);
      color: var(--text-primary);
    }

    .btn-green {
      background: var(--green-glow);
      color: var(--green);
      border-color: rgba(62, 201, 200, 0.3);
    }

    .btn-green:hover {
      background: var(--green);
      color: #fff;
    }

    .btn-add-stage {
      background: var(--surface);
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      width: 100%;
      justify-content: center;
      padding: 0.65rem;
      font-size: 13px;
    }

    .btn-add-stage:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    /* ─── RIGHT PANEL (preview) ─── */
    #preview-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    #preview-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      height: 52px;
      border-bottom: 1px solid var(--border);
      background: var(--mid);
      flex-shrink: 0;
      gap: 1rem;
    }

    #preview-action-group {
      display: flex;
      gap: 1rem;
    }

    .tab-group {
      display: flex;
      gap: 0.15rem;
      background: var(--surface);
      border-radius: var(--radius);
      padding: 0.2rem;
      border: 1px solid var(--border);
    }

    .tab-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 0.3rem 0.75rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .tab-btn.active {
      background: var(--accent-glow);
      color: var(--accent);
    }

    #preview-content {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .preview-pane {
      position: absolute;
      inset: 0;
      overflow-y: auto;
      padding: 1.5rem;
      display: none;
    }

    .preview-pane.active {
      display: block;
    }

    /* TTXF preview (raw text) */
    #pane-preview pre {
      font-family: var(--font-mono);
      font-size: 12px;
      line-height: 1.7;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Syntax highlight colours */
    .ttxf-directive {
      color: var(--amber);
    }

    .ttxf-stage {
      color: var(--accent);
      font-weight: 600;
    }

    .ttxf-array {
      color: var(--green);
    }

    .ttxf-item {
      color: var(--text-secondary);
    }

    .ttxf-question {
      color: #c792ea;
    }

    .ttxf-correct {
      color: var(--green);
    }

    .ttxf-comment {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Visual preview */
    #pane-visual .preview-stage {
      background: var(--mid);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: 1rem;
      overflow: hidden;
    }

    #pane-visual .preview-stage-header {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.85rem 1rem;
      border-bottom: 1px solid var(--border);
    }

    #pane-visual .preview-stage-num {
      font-family: var(--font-mono);
      font-size: 10px;
      padding: 0.2rem 0.5rem;
      border-radius: 99px;
      background: var(--surface-raised);
      color: var(--text-muted);
      border: 1px solid var(--border);
    }

    #pane-visual .preview-stage-title {
      font-size: 13.5px;
      font-weight: 600;
      color: var(--text-primary);
    }

    #pane-visual .preview-stage-body {
      padding: 0.75rem 1rem;
    }

    #pane-visual .preview-section-label {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin: 0.5rem 0 0.3rem;
    }

    #pane-visual .preview-discussion-item {
      font-size: 12.5px;
      color: var(--text-secondary);
      padding: 0.25rem 0 0.25rem 1rem;
      border-left: 2px solid var(--accent);
      margin-bottom: 0.3rem;
    }

    /* Talk / discussion block — matches tool's .talk */
    #pane-visual .preview-talk {
      margin: 0.5rem 0.75rem 0.5rem;
      padding: 0.75rem 0.85rem;
      background: rgba(0, 51, 102, 0.25);
      border-left: 3px solid var(--accent);
      border-radius: 0 var(--radius) var(--radius) 0;
      display: flex;
      gap: 0.65rem;
    }

    #pane-visual .preview-talk-icon {
      flex-shrink: 0;
    }

    #pane-visual .preview-talk-icon svg {
      fill: var(--accent);
      width: 16px;
      height: 16px;
      margin-top: 2px;
    }

    #pane-visual .preview-talk ul {
      padding-left: 1rem;
      font-size: 12.5px;
      color: var(--text-secondary);
      line-height: 1.7;
      list-style: disc;
    }

    #pane-visual .preview-talk ul li {
      margin-bottom: 0.25rem;
    }

    /* Prompt block — matches tool's .prompt */
    #pane-visual .preview-prompt {
      margin: 0.5rem 0.75rem 0.5rem;
      padding: 0.75rem 0.85rem;
      background: rgba(245, 166, 35, 0.06);
      border-left: 3px solid var(--amber);
      border-radius: 0 var(--radius) var(--radius) 0;
      display: flex;
      gap: 0.65rem;
    }

    #pane-visual .preview-prompt-icon {
      flex-shrink: 0;
    }

    #pane-visual .preview-prompt-icon svg {
      fill: var(--amber);
      width: 16px;
      height: 16px;
      margin-top: 2px;
    }

    #pane-visual .preview-prompt ul {
      padding-left: 1rem;
      font-size: 12.5px;
      color: var(--text-secondary);
      line-height: 1.7;
      list-style: disc;
    }

    #pane-visual .preview-prompt ul li {
      margin-bottom: 0.25rem;
    }

    #pane-visual .preview-question {
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      border-radius: var(--radius);
      padding: 0.65rem 0.85rem;
      margin-bottom: 0.5rem;
    }

    #pane-visual .preview-question.quiz-q {
      border-left-color: var(--green);
    }

    #pane-visual .preview-q-text {
      font-size: 12.5px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.4rem;
    }

    #pane-visual .preview-answers {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    #pane-visual .preview-answer {
      font-size: 11.5px;
      padding: 0.25rem 0.6rem;
      border-radius: 99px;
      border: 1px solid var(--border);
      background: var(--surface-raised);
      color: var(--text-secondary);
      font-style: italic;
    }

    #pane-visual .preview-answer.correct {
      border-color: rgba(62, 201, 200, 0.4);
      color: var(--green);
      background: var(--green-glow);
    }

    /* ─── EMPTY STATE ─── */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 0.75rem;
      color: var(--text-muted);
      text-align: center;
      padding: 2rem;
    }

    .empty-state svg {
      fill: var(--text-muted);
      width: 36px;
      height: 36px;
      opacity: 0.4;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* ─── MODAL ─── */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(10, 13, 20, 0.8);
      backdrop-filter: blur(6px);
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    .modal-card {
      background: var(--mid);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 460px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-header h2 {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1.5rem 1.25rem;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.15);
    }

    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      padding: 2.5rem 1.5rem;
      text-align: center;
      color: var(--text-muted);
      transition: all 0.18s;
      cursor: pointer;
      font-size: 13px;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--accent);
      background: var(--accent-glow);
      color: var(--accent);
    }

    .drop-zone svg {
      fill: currentColor;
      width: 32px;
      height: 32px;
      margin-bottom: 0.75rem;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    /* ─── RESPONSIVE ─── */
    @media (max-width: 768px) {
      #site-nav .nav-links {
        display: none;
      }

      #site-nav .nav-hamburger {
        display: block;
      }

      #editor-panel {
        width: 100%;
        min-width: unset;
        border-right: none;
      }

      #preview-panel {
        display: none;
      }

      #editor-wrap {
        height: calc(100vh - 56px);
      }
    }
  </style>
</head>

<body>

  <!-- ══════════════════════════════════════════
       NAVIGATION
       ══════════════════════════════════════════ -->
  <nav id="site-nav" role="navigation" aria-label="Main navigation">
    <a href="ttxgym.com" class="nav-logo" aria-label="TTX Gym Home">
      <svg viewBox="0 0 210 84" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <g>
          <path style="fill:#ffffff"
            d="m 123.95944,30.43245 0.001,-1.117375 5.11724,-6.112717 c 2.81453,-3.361993 5.11729,-6.171028 5.11729,-6.242298 0,-0.07123 -2.30323,-2.881476 -5.1183,-6.244894 l -5.1183,-6.1153013 v -1.086954 -1.086943 l 3.28003,0.0063 3.28005,0.0063 3.8207,4.544782 c 2.10139,2.499633 3.91803,4.6295583 4.03697,4.7331703 0.18592,0.161956 0.77129,-0.476686 4.17186,-4.5515563 l 3.95559,-4.739934 h 3.28934 3.28932 v 1.052384 1.052384 l -5.19039,6.1834383 c -2.85472,3.400899 -5.1886,6.219979 -5.18639,6.264626 0.002,0.04464 2.33524,2.838581 5.18451,6.208731 l 5.18051,6.127543 0.006,1.117375 0.006,1.117376 -3.28004,-0.0032 -3.28003,-0.0032 -4.03542,-4.764205 c -3.77303,-4.454434 -4.04959,-4.7469 -4.25324,-4.498099 -0.1198,0.146359 -1.92418,2.291532 -4.00975,4.767043 l -3.792,4.500917 h -3.23672 -3.23673 l 0.001,-1.117376 z" />
          <path style="fill:#ffffff"
            d="M 103.62935,20.159802 V 8.7697787 h -5.767107 -5.767099 v -3.171906 -3.171905 h 14.634016 14.63402 v 3.171905 3.171906 h -5.69501 -5.69501 V 20.159802 31.549826 h -3.1719 -3.17191 z" />
          <path style="fill:#ffffff"
            d="M 71.045229,20.159802 V 8.7697787 h -5.695017 -5.695007 v -3.171906 -3.171905 h 14.561929 14.561929 v 3.171905 3.171906 H 83.084046 77.38904 V 20.159802 31.549826 h -3.171906 -3.171905 z" />
          <path style="fill:#1a6ec0"
            d="m 56.568246,44.749266 c 0.132103,-1.130608 0.11982,-5.393817 -0.01826,-6.336905 l -0.09381,-0.640428 h 50.057284 50.05728 l -0.0914,0.775254 c -0.14125,1.198686 -0.15482,4.546774 -0.0241,5.932418 l 0.1177,1.247158 H 106.51352 56.453986 Z" />
          <path style="fill:#1a6ec0"
            d="m 200.94868,51.986986 c 0,-0.01984 -0.19934,-0.522652 -0.44235,-1.117376 -0.24303,-0.594734 -0.62663,-1.835993 -0.85249,-2.758363 -1.17752,-4.80902 -0.86406,-9.679602 0.90117,-14.002281 l 0.57405,-1.405726 h 4.0357 4.03569 l -0.26157,0.39649 c -1.23002,1.864399 -2.0063,3.624311 -2.54655,5.77324 -0.26627,1.059149 -0.3139,1.638572 -0.30464,3.706429 0.0142,3.191363 0.30209,4.354515 1.81632,7.340458 l 1.06655,2.103165 h -4.01068 c -2.20589,0 -4.01093,-0.01625 -4.0112,-0.03609 z" />
          <path style="fill:#1a6ec0"
            d="m 3.0885296,51.941186 c 0,-0.04506 0.44678,-0.969549 0.99284,-2.054529 1.56297,-3.105469 1.81674,-4.159426 1.81148,-7.523519 -0.003,-2.117705 -0.0453,-2.529327 -0.38251,-3.748616 -0.62502,-2.259971 -1.27274,-3.70054 -2.47959,-5.514785 l -0.26374,-0.396489 h 4.03913 4.0391284 l 0.508459,1.214635 c 1.175244,2.807495 1.592501,5.008816 1.600805,8.445255 0.0084,3.455866 -0.441579,6.004916 -1.515078,8.583574 l -0.448069,1.076317 H 7.0399596 c -2.17329,0 -3.95143,-0.03683 -3.95143,-0.08188 z" />
          <path style="fill:#1a6ec0"
            d="m 188.14448,64.45835 c -4.60694,-9.066036 -6.34795,-19.950671 -4.79103,-29.952887 0.79263,-5.092105 2.34256,-10.128325 4.37061,-14.201486 l 0.75375,-1.513865 5.15491,-0.03788 5.15492,-0.03788 -1.44187,2.36676 c -1.68405,2.764325 -2.62234,4.771433 -3.60217,7.705364 -1.48568,4.448683 -2.16923,8.595656 -2.16312,13.123333 0.0109,8.068699 2.41694,16.120002 6.77075,22.656654 0.44893,0.674024 0.86412,1.306609 0.92263,1.405726 0.0843,0.142814 -0.97051,0.180221 -5.08108,0.180221 h -5.18744 z" />
          <path style="fill:#1a6ec0"
            d="M 13.442562,64.890886 C 21.430959,52.97521 22.612598,37.550731 16.537975,24.485129 16.224594,23.811095 15.34227,22.237758 14.577265,20.988827 L 13.186333,18.71803 h 5.166097 5.166087 l 0.803415,1.698254 c 5.365207,11.340999 6.308978,24.008992 2.687685,36.076248 -0.753947,2.512395 -1.94733,5.507012 -3.117002,7.821643 l -0.928945,1.838262 h -5.183434 -5.183435 z" />
          <path style="fill:#1a6ec0"
            d="m 174.53173,78.948193 c -5.15518,-8.267119 -8.66247,-19.326858 -9.79592,-30.890037 -0.24331,-2.48236 -0.24156,-10.536496 0.003,-12.975982 1.12233,-11.203007 4.06279,-20.780917 9.1843,-29.9160563 l 1.53618,-2.74015 h 5.47631 5.47631 l -0.49924,0.68484 c -2.41341,3.310656 -5.29765,8.4418153 -7.00382,12.4600833 -6.83569,16.098892 -7.07266,34.022086 -0.66592,50.365278 1.74301,4.446298 4.74992,9.997815 7.52608,13.895014 0.41656,0.58477 0.72226,1.12003 0.67935,1.18946 -0.0429,0.0694 -2.43321,0.12626 -5.31175,0.12626 h -5.23371 z" />
          <path style="fill:#ffffff"
            d="M 121.65153,67.017498 V 52.888101 l 3.13587,5.7e-4 3.13586,5.8e-4 3.17191,3.780699 c 1.74455,2.079391 3.89837,4.64314 4.78628,5.697244 l 1.61436,1.916538 4.77081,-5.697761 4.77081,-5.69787 h 3.16659 3.16657 v 14.129397 14.129405 h -3.09878 -3.09876 l -0.0371,-9.382769 -0.037,-9.382768 -4.75785,5.697085 c -2.61683,3.1334 -4.7903,5.700884 -4.82996,5.705506 -0.0397,0.0042 -2.24556,-2.565511 -4.90203,-5.711405 l -4.82995,-5.719804 -0.037,9.397077 -0.0371,9.397078 h -3.02668 -3.02669 z" />
          <path style="fill:#ffffff"
            d="m 100.45743,75.865912 v -5.280979 l -1.344169,-1.819764 c -0.739298,-1.000858 -3.6589,-4.950452 -6.487984,-8.776859 -2.829095,-3.826422 -5.143811,-6.989316 -5.143811,-7.028665 0,-0.03936 1.617879,-0.07154 3.595271,-0.07154 h 3.595282 l 4.42039,5.550836 c 2.431221,3.05296 4.432961,5.550842 4.448301,5.550842 0.0153,0 2.00418,-2.497006 4.41964,-5.54889 l 4.39174,-5.548884 3.64048,-0.0021 c 2.00227,-0.001 3.64048,0.03218 3.64048,0.07376 0,0.04168 -1.83591,2.555739 -4.0798,5.586882 -2.24389,3.031139 -5.16348,6.979234 -6.48798,8.773567 l -2.40819,3.262401 v 5.280114 5.2801 h -3.09983 -3.09982 z" />
          <path style="fill:#ffffff"
            d="m 62.502123,80.992853 c -1.603358,-0.38525 -3.146168,-1.67929 -3.90041,-3.2715 l -0.460373,-0.97187 v -9.731985 -9.731983 l 0.47064,-0.962093 c 0.817123,-1.670376 2.149173,-2.774973 3.881596,-3.2188 0.768181,-0.196799 2.098574,-0.22127 10.08887,-0.185561 9.200985,0.04115 9.204277,0.04126 10.016894,0.369845 1.187347,0.480148 2.594836,1.823046 3.180052,3.034115 0.444291,0.91942 0.467685,1.054456 0.522915,3.017034 l 0.05783,2.05453 h -3.115852 -3.115852 v -1.153422 -1.153422 h -8.003075 -8.003064 l 0.03725,7.965804 0.03725,7.965814 7.965804,0.03725 7.965804,0.03725 v -2.163882 -2.163893 h -3.027719 -3.02773 v -3.02772 -3.02773 h 6.134855 6.134866 l -0.04337,6.019414 -0.04337,6.019405 -0.463865,0.94788 c -0.594481,1.21481 -1.698782,2.31911 -2.913576,2.91359 l -0.947886,0.46386 -9.443633,0.0241 c -5.211651,0.0133 -9.686177,-0.0342 -9.984879,-0.106 z" />
          <path style="fill:#1a6ec0"
            d="m 25.519705,81.021453 c -0.0439,-0.071 0.03978,-0.28263 0.185983,-0.47036 1.311927,-1.68534 3.639855,-5.502462 5.220114,-8.559464 C 37.220777,59.814061 39.557125,45.873306 37.606851,32.126537 36.200366,22.212685 32.499604,12.59703 26.939043,4.4084047 l -1.3462,-1.982437 5.436392,0.0021 5.436382,0.0021 1.40982,2.557101 c 2.522363,4.575035 4.243812,8.5214633 5.769337,13.2262383 6.107588,18.835993 4.615545,39.223717 -4.167783,56.950123 -0.589373,1.189457 -1.607315,3.006103 -2.262092,4.036963 l -1.190513,1.87431 -5.212463,0.0379 c -2.957294,0.0214 -5.24697,-0.0179 -5.292218,-0.0912 z" />
        </g>
      </svg>
    </a>
    <ul class="nav-links">
      <li><a href="index.html">About</a></li>
      <li><a href="guide.html">How To Use</a></li>
      <li><a href="library.html">Exercise Library</a></li>
      <li><a href="editor.html" class="active">Exercise Builder</a></li>
      <li><a href="gym/" class="launch">Launch</a></li>
    </ul>
    <button class="nav-hamburger" onclick="document.getElementById('mobile-nav').classList.toggle('open')"
      aria-label="Toggle menu">&#9776;</button>
  </nav>

  <div id="mobile-nav" role="navigation" aria-label="Mobile navigation">
    <a href="index.html">About</a>
    <a href="guide.html">How To Use</a>
    <a href="library.html">Exercise Library</a>
    <a href="editor.html">Exercise Builder</a>
    <a href="gym/" class="launch">Launch</a>
  </div>

  <!-- ══════════════════════════════════════════
       EDITOR
       ══════════════════════════════════════════ -->
  <div id="editor-wrap">

    <!-- ── LEFT: EDITOR PANEL ── -->
    <div id="editor-panel">
      <div id="editor-topbar">
        <h1>TTX Scenario Builder</h1>
        <div class="topbar-actions">
          <button class="btn btn-ghost" onclick="openImportModal()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
              <path
                d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
            </svg>
            Import
          </button>
          <button class="btn btn-green" onclick="exportTTXF()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
              <path
                d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
            </svg>
            Export
          </button>
        </div>
      </div>

      <div id="editor-scroll">

        <!-- Scenario metadata -->
        <div class="field-group meta">
          <label class="field-label" for="f-title"><span class="sigil">!</span> Scenario Title</label>
          <input id="f-title" class="field-input" type="text" placeholder="e.g. Ransomware Attack Response"
            oninput="scheduleUpdate()">
        </div>

        <div class="field-group meta">
          <label class="field-label" for="f-author"><span class="sigil">!</span> Author <span
              style="opacity:0.5">(optional)</span></label>
          <input id="f-author" class="field-input" type="text" placeholder="e.g. Jane Smith" oninput="scheduleUpdate()">
        </div>

        <div class="field-group meta">
          <label class="field-label" for="f-summary"><span class="sigil">!</span> Summary</label>
          <textarea id="f-summary" class="field-input" placeholder="Brief overview of this exercise scenario…"
            oninput="scheduleUpdate()"></textarea>
        </div>

        <div class="field-group meta">
          <label class="field-label" for="f-conclusion"><span class="sigil">!</span> Conclusion <span
              style="opacity:0.5">(optional)</span></label>
          <textarea id="f-conclusion" class="field-input" placeholder="Custom debrief text shown on the finish screen…"
            oninput="scheduleUpdate()"></textarea>
        </div>

        <!-- Stages -->
        <div>
          <div class="section-header">
            <div class="section-label">@ Stages</div>
          </div>
          <div id="stages-list"></div>
          <button class="btn btn-add-stage" onclick="addStage()" style="margin-top:0.75rem">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"
              style="width:16px;height:16px;fill:currentColor">
              <path d="M440-440H200v-80h240v-240h80v240h240v80H520v240h-80v-240Z" />
            </svg>
            Add Stage
          </button>
        </div>

      </div>
    </div>

    <!-- ── RIGHT: PREVIEW PANEL ── -->
    <div id="preview-panel">
      <div id="preview-topbar">
        <div id="preview-action-group">
          <div class="tab-group">
            <button class="tab-btn active" data-tab="pane-preview" onclick="switchTab(this)">TTXF</button>
            <button class="tab-btn" data-tab="pane-visual" onclick="switchTab(this)">Visual</button>
          </div>

          <button class="btn btn-ghost" onclick="postToNewTab()">
            Preview in TTX GYM
          </button>
        </div>
        <div style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted)" id="preview-filename">
          untitled.ttxf</div>
      </div>

      <div id="preview-content">
        <div id="pane-preview" class="preview-pane active">
          <pre
            id="ttxf-output"><span style="color:var(--text-muted);font-style:italic">// Start filling in the form to see your scenario file here…</span></pre>
        </div>
        <div id="pane-visual" class="preview-pane">
          <div id="visual-output"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- ══════════════════════════════════════════
       IMPORT MODAL
       ══════════════════════════════════════════ -->
  <div id="import-modal" class="modal-backdrop" onclick="handleModalBackdropClick(event)">
    <div class="modal-card" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>Import TTXF File</h2>
        <button class="icon-btn" onclick="closeImportModal()" aria-label="Close">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
            <path
              d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z" />
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="drop-zone" id="drop-zone" onclick="document.getElementById('import-file-input').click()"
          ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
            <path
              d="M440-320v-326L336-542l-56-58 200-200 200 200-56 58-104-104v326h-80ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
          </svg>
          <div>Drag and drop a <code
              style="font-family:var(--font-mono);font-size:11px;background:var(--surface-raised);padding:2px 6px;border-radius:4px;">.ttxf</code>
            file here, or click to select</div>
          <input type="file" id="import-file-input" accept=".ttxf,.txt" style="display:none"
            onchange="handleImportFile(event)">
        </div>
        <div id="import-status"
          style="margin-top:0.75rem;font-size:12px;font-family:var(--font-mono);color:var(--text-muted);min-height:1.2em">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeImportModal()">Cancel</button>
        <button class="btn btn-primary" id="import-confirm-btn" onclick="confirmImport()" disabled
          style="opacity:0.5">Import</button>
      </div>
    </div>
  </div>

  <script>
    /* =============================================
       STATE
       ============================================= */
    let stages = [];
    let updateTimer = null;
    let pendingImportData = null;
    let _idCounter = 1;
    function nextId() { return _idCounter++; }

    /* =============================================
       STAGE MODEL
       ============================================= */
    function makeStage() {
      return {
        id: nextId(),
        title: '',
        content: '',
        discussion: [],
        prompts: [],
        questions: []
      };
    }

    function makeQuestion() {
      return { id: nextId(), text: '', type: 'rating', answers: ['', ''], quiz: '' };
    }

    /* =============================================
       STAGE MANAGEMENT
       ============================================= */
    function addStage(data) {
      const stage = data || makeStage();
      stages.push(stage);
      renderStage(stage, stages.length - 1);
      scheduleUpdate();
    }

    function removeStage(id) {
      id = +id;
      stages = stages.filter(s => s.id !== id);
      renderAllStages();
      scheduleUpdate();
    }

    function moveStage(id, dir) {
      id = +id;
      const i = stages.findIndex(s => s.id === id);
      const j = i + dir;
      if (j < 0 || j >= stages.length) return;
      [stages[i], stages[j]] = [stages[j], stages[i]];
      renderAllStages();
      scheduleUpdate();
    }

    function renderAllStages() {
      const list = document.getElementById('stages-list');
      list.innerHTML = '';
      stages.forEach((s, i) => renderStage(s, i));
    }

    function renderStage(stage, idx) {
      const list = document.getElementById('stages-list');
      const card = document.createElement('div');
      card.className = 'stage-card';
      card.id = 'stage-card-' + stage.id;

      card.innerHTML = `
    <div class="stage-card-header" onclick="toggleStageCard('${stage.id}')">
      <div class="stage-card-left">
        <span class="stage-num-badge">Stage ${idx + 1}</span>
        <input class="stage-card-title-input" type="text" placeholder="Stage title…"
               value="${escH(stage.title)}"
               onclick="event.stopPropagation()"
               oninput="updateStageField('${stage.id}','title',this.value)">
      </div>
      <div class="stage-card-actions">
        <button class="icon-btn" onclick="event.stopPropagation();moveStage('${stage.id}',-1)" title="Move up">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M440-160v-487L216-423l-56-57 320-320 320 320-56 57-224-224v487h-80Z"/></svg>
        </button>
        <button class="icon-btn" onclick="event.stopPropagation();moveStage('${stage.id}',1)" title="Move down">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M440-800v487L216-537l-56 57 320 320 320-320-56-57-224 224v-487h-80Z"/></svg>
        </button>
        <button class="icon-btn danger" onclick="event.stopPropagation();removeStage('${stage.id}')" title="Remove stage">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>
        </button>
        <button class="icon-btn sc_toggle-btn" onclick="event.stopPropagation();toggleStageCard('${stage.id}')">▼</button>
      </div>
    </div>
    <div class="stage-card-body" id="stage-body-${stage.id}">
      <div class="stage-card-inner">

        <div class="field-group" style="margin-top:0.5rem">
          <label class="field-label" style="color:var(--ttxf-stage)"><span class="sigil">@</span> Stage Content</label>
          <textarea class="field-input" placeholder="Scenario content for this stage…" rows="3"
                    oninput="updateStageField('${stage.id}','content',this.value)">${escH(stage.content)}</textarea>
        </div>

        <div class="field-group">
          <div class="array-section-label"><span class="sigil">#</span> Discussion Points</div>
          <div class="array-field discussion-field" id="discussion-${stage.id}">
            ${stage.discussion.map((d, i) => discussionItemHTML(stage.id, i, d)).join('')}
          </div>
          <button class="add-item-btn add-discussion-btn" onclick="addDiscussionItem('${stage.id}')">+ Add Discussion Point</button>
        </div>

        <div class="field-group">
          <div class="array-section-label" style="color:var(--ttxf-directive)"><span class="sigil" style="color:var(--ttxf-directive)">!</span> Facilitator Prompts</div>
          <div class="array-field prompts-field" id="prompts-${stage.id}">
            ${stage.prompts.map((p, i) => promptItemHTML(stage.id, i, p)).join('')}
          </div>
          <button class="add-item-btn add-prompt-btn" onclick="addPromptItem('${stage.id}')">+ Add Prompt</button>
        </div>

        <div class="field-group">
          <div class="question-section-label"><span class="sigil">?</span> Questions</div>
          <div class="questions-section" id="questions-${stage.id}">
            ${stage.questions.map((q, i) => questionCardHTML(stage.id, i, q)).join('')}
          </div>
          <button class="add-item-btn add-question-btn" onclick="addQuestion('${stage.id}')">+ Add Question</button>
        </div>

      </div>
    </div>
  `;

      list.appendChild(card);

      // Auto-expand newly added stages
      const body = card.querySelector('.stage-card-body');
      requestAnimationFrame(() => {
        body.style.height = body.scrollHeight + 'px';
        setTimeout(() => { if (body.style.height !== '0px') body.style.height = 'auto'; }, 300);
      });
    }

    function discussionItemHTML(stageId, idx, val) {
      return `<div class="array-item" id="disc-item-${stageId}-${idx}">
    <input class="field-input" type="text" placeholder="Discussion point…" value="${escH(val)}"
           oninput="updateArrayItem('${stageId}','discussion',${idx},this.value)">
    <button class="icon-btn danger array-item-remove" onclick="removeArrayItem('${stageId}','discussion',${idx})">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
    </button>
  </div>`;
    }

    function promptItemHTML(stageId, idx, val) {
      return `<div class="array-item" id="prompt-item-${stageId}-${idx}">
    <input class="field-input" type="text" placeholder="Facilitator prompt…" value="${escH(val)}"
           oninput="updateArrayItem('${stageId}','prompts',${idx},this.value)">
    <button class="icon-btn danger array-item-remove" onclick="removeArrayItem('${stageId}','prompts',${idx})">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
    </button>
  </div>`;
    }

    function questionCardHTML(stageId, qIdx, q) {
      const isQuiz = q.type === 'quiz';
      return `<div class="question-card" id="qcard-${q.id}">
    <div class="question-card-header">
      <div class="q-type-toggle">
        <button class="${!isQuiz ? 'active' : ''}" onclick="setQuestionType('${stageId}','${q.id}','rating')">Rating</button>
        <button class="${isQuiz ? 'active quiz-type' : ''}" onclick="setQuestionType('${stageId}','${q.id}','quiz')">Quiz</button>
      </div>
      <input class="field-input" type="text" placeholder="Question text…" value="${escH(q.text)}"
             style="flex:1;margin-left:0.5rem"
             oninput="updateQuestionField('${stageId}','${q.id}','text',this.value)">
      <button class="icon-btn danger" style="margin-left:0.25rem" onclick="removeQuestion('${stageId}','${q.id}')">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
      </button>
    </div>
    <div class="answers-list" id="answers-${q.id}">
      ${q.answers.map((a, ai) => answerHTML(stageId, q, ai, a)).join('')}
    </div>
    <button class="add-item-btn" onclick="addAnswer('${stageId}','${q.id}')">+ Add Answer</button>
  </div>`;
    }

    function answerHTML(stageId, q, ai, val) {
      const isCorrect = q.type === 'quiz' && q.quiz === val && val !== '';
      return `<div class="answer-item" id="ans-${q.id}-${ai}">
    ${q.type === 'quiz'
          ? `<button class="answer-correct-toggle ${isCorrect ? 'correct' : ''}"
               title="Mark as correct answer"
               onclick="setCorrectAnswer('${stageId}','${q.id}',${ai})"></button>`
          : `<span style="font-family:var(--font-mono);font-size:11px;color:var(--text-muted);padding:0 0.25rem;flex-shrink:0">${ai + 1}</span>`}
    <input class="field-input" type="text" placeholder="Answer option…" value="${escH(val)}"
           oninput="updateAnswer('${stageId}','${q.id}',${ai},this.value)">
    <button class="icon-btn danger array-item-remove" onclick="removeAnswer('${stageId}','${q.id}',${ai})">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>
    </button>
  </div>`;
    }

    /* =============================================
       STAGE COLLAPSIBLE
       ============================================= */
    function toggleStageCard(id) {
      const body = document.getElementById('stage-body-' + id);
      const btn = document.querySelector('#stage-card-' + id + ' .sc_toggle-btn');
      const isOpen = body.style.height !== '0px' && body.style.height !== '';
      if (isOpen) {
        if (body.style.height === 'auto') {
          body.style.height = body.scrollHeight + 'px';
          body.getBoundingClientRect();
        }
        body.style.height = '0px';
        if (btn) btn.textContent = '▼';
      } else {
        body.style.height = body.scrollHeight + 'px';
        if (btn) btn.textContent = '▲';
        setTimeout(() => { if (body.style.height !== '0px') body.style.height = 'auto'; }, 300);
      }
    }

    /* =============================================
       FIELD UPDATES
       ============================================= */
    function updateStageField(id, field, val) {
      const s = stages.find(s => s.id == id);
      if (s) { s[field] = val; scheduleUpdate(); }
    }

    function updateArrayItem(stageId, field, idx, val) {
      const s = stages.find(s => s.id == stageId);
      if (s) { s[field][idx] = val; scheduleUpdate(); }
    }

    function removeArrayItem(stageId, field, idx) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      s[field].splice(idx, 1);
      const container = document.getElementById(field === 'discussion' ? 'discussion-' + stageId : 'prompts-' + stageId);
      container.innerHTML = s[field].map((v, i) =>
        field === 'discussion' ? discussionItemHTML(stageId, i, v) : promptItemHTML(stageId, i, v)
      ).join('');
      scheduleUpdate();
    }

    function addDiscussionItem(stageId) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      s.discussion.push('');
      const container = document.getElementById('discussion-' + stageId);
      const idx = s.discussion.length - 1;
      container.insertAdjacentHTML('beforeend', discussionItemHTML(stageId, idx, ''));
      container.lastElementChild.querySelector('input').focus();
      reheatCard(stageId);
      scheduleUpdate();
    }

    function addPromptItem(stageId) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      s.prompts.push('');
      const container = document.getElementById('prompts-' + stageId);
      const idx = s.prompts.length - 1;
      container.insertAdjacentHTML('beforeend', promptItemHTML(stageId, idx, ''));
      container.lastElementChild.querySelector('input').focus();
      reheatCard(stageId);
      scheduleUpdate();
    }

    function updateQuestionField(stageId, qId, field, val) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      const q = s.questions.find(q => q.id == qId);
      if (q) { q[field] = val; scheduleUpdate(); }
    }

    function setQuestionType(stageId, qId, type) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      const q = s.questions.find(q => q.id == qId);
      if (!q) return;
      q.type = type;
      if (type === 'rating') q.quiz = '';
      const card = document.getElementById('qcard-' + qId);
      if (card) card.outerHTML = questionCardHTML(stageId, null, q);
      reheatCard(stageId);
      scheduleUpdate();
    }

    function setCorrectAnswer(stageId, qId, ai) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      const q = s.questions.find(q => q.id == qId);
      if (!q) return;
      q.quiz = q.answers[ai];
      const container = document.getElementById('answers-' + qId);
      if (container) container.innerHTML = q.answers.map((a, i) => answerHTML(stageId, q, i, a)).join('');
      scheduleUpdate();
    }

    function addQuestion(stageId) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      const q = makeQuestion();
      s.questions.push(q);
      const container = document.getElementById('questions-' + stageId);
      container.insertAdjacentHTML('beforeend', questionCardHTML(stageId, s.questions.length - 1, q));
      reheatCard(stageId);
      scheduleUpdate();
    }

    function removeQuestion(stageId, qId) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      s.questions = s.questions.filter(q => q.id != qId);
      const container = document.getElementById('questions-' + stageId);
      container.innerHTML = s.questions.map((q, i) => questionCardHTML(stageId, i, q)).join('');
      reheatCard(stageId);
      scheduleUpdate();
    }

    function updateAnswer(stageId, qId, ai, val) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      const q = s.questions.find(q => q.id == qId);
      if (!q) return;
      const wasCorrect = q.quiz === q.answers[ai];
      q.answers[ai] = val;
      if (wasCorrect) q.quiz = val;
      scheduleUpdate();
    }

    function addAnswer(stageId, qId) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      const q = s.questions.find(q => q.id == qId);
      if (!q) return;
      q.answers.push('');
      const container = document.getElementById('answers-' + qId);
      const ai = q.answers.length - 1;
      container.insertAdjacentHTML('beforeend', answerHTML(stageId, q, ai, ''));
      container.lastElementChild.querySelector('input').focus();
      reheatCard(stageId);
      scheduleUpdate();
    }

    function removeAnswer(stageId, qId, ai) {
      const s = stages.find(s => s.id == stageId);
      if (!s) return;
      const q = s.questions.find(q => q.id == qId);
      if (!q) return;
      if (q.answers.length <= 2) return; // minimum 2 answers
      if (q.quiz === q.answers[ai]) q.quiz = '';
      q.answers.splice(ai, 1);
      const container = document.getElementById('answers-' + qId);
      container.innerHTML = q.answers.map((a, i) => answerHTML(stageId, q, i, a)).join('');
      reheatCard(stageId);
      scheduleUpdate();
    }

    // Re-measure card height after DOM mutations
    function reheatCard(stageId) {
      const body = document.getElementById('stage-body-' + stageId);
      if (!body || body.style.height === '0px') return;
      body.style.height = 'auto';
    }

    /* =============================================
       TTXF GENERATION
       ============================================= */
    function buildTTXF() {
      const title = document.getElementById('f-title').value.trim();
      const author = document.getElementById('f-author').value.trim();
      const summary = document.getElementById('f-summary').value.trim();
      const conclusion = document.getElementById('f-conclusion').value.trim();

      let lines = [];
      if (title) lines.push('! title: ' + title);
      if (author) lines.push('! author: ' + author);
      if (summary) {
        if (summary.includes('\n')) {
          lines.push('! summary'); lines.push(summary); lines.push('');
        } else {
          lines.push('! summary: ' + summary);
        }
      }
      if (conclusion) {
        if (conclusion.includes('\n')) {
          lines.push('! conclusion'); lines.push(conclusion); lines.push('');
        } else {
          lines.push('! conclusion: ' + conclusion);
        }
      }

      stages.forEach(s => {
        lines.push('');
        lines.push('@ ' + (s.title || 'Untitled Stage'));
        if (s.content.trim()) {
          if (s.content.includes('\n')) {
            lines.push('! content');
            lines.push(s.content.trim());
            lines.push('');
          } else {
            lines.push('! content: ' + s.content.trim());
          }
        }
        if (s.discussion.filter(d => d.trim()).length) {
          lines.push('# discussion');
          s.discussion.filter(d => d.trim()).forEach(d => lines.push('+ ' + d));
        }
        if (s.prompts.filter(p => p.trim()).length) {
          lines.push('# prompts');
          s.prompts.filter(p => p.trim()).forEach(p => lines.push('+ ' + p));
        }
        s.questions.forEach(q => {
          if (!q.text.trim() && !q.answers.filter(a => a.trim()).length) return;
          lines.push('? ' + (q.text || 'Question'));
          q.answers.forEach(a => {
            if (!a.trim()) return;
            lines.push((q.type === 'quiz' && q.quiz === a ? '++ ' : '+ ') + a);
          });
        });
      });

      return lines.join('\n');
    }

    /* =============================================
       PREVIEW UPDATE
       ============================================= */
    function scheduleUpdate() {
      clearTimeout(updateTimer);
      updateTimer = setTimeout(updatePreviews, 120);
    }

    function updatePreviews() {
      const ttxf = buildTTXF();
      const title = document.getElementById('f-title').value.trim();
      document.getElementById('preview-filename').textContent = (title || 'untitled').toLowerCase().replace(/\s+/g, '-') + '.ttxf';
      document.getElementById('ttxf-output').innerHTML = syntaxHighlight(ttxf);
      buildVisualPreview();
    }

    function syntaxHighlight(text) {
      return text.split('\n').map(line => {
        const t = line.trim();
        if (t.startsWith('//')) return `<span class="ttxf-comment">${escH(line)}</span>`;
        if (t.startsWith('! ')) return `<span class="ttxf-directive">${escH(line)}</span>`;
        if (t.startsWith('@ ')) return `<span class="ttxf-stage">${escH(line)}</span>`;
        if (t.startsWith('# ')) return `<span class="ttxf-array">${escH(line)}</span>`;
        if (t.startsWith('++ ')) return `<span class="ttxf-correct">${escH(line)}</span>`;
        if (t.startsWith('+ ')) return `<span class="ttxf-item">${escH(line)}</span>`;
        if (t.startsWith('? ')) return `<span class="ttxf-question">${escH(line)}</span>`;
        return `<span class="ttxf-item">${escH(line)}</span>`;
      }).join('\n');
    }

    function buildVisualPreview() {
      const out = document.getElementById('visual-output');
      if (!stages.length) {
        out.innerHTML = `<div class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M320-400h80v-80q0-17 11.5-28.5T440-520h80v80l120-120-120-120v80h-80q-50 0-85 35t-35 85v80ZM160-240q-33 0-56.5-23.5T80-320v-440q0-33 23.5-56.5T160-840h640q33 0 56.5 23.5T880-760v440q0 33-23.5 56.5T800-240H240L80-80Zm0-80h640v-440H160v440Z"/></svg>
      <p>Add stages to see a visual preview</p>
    </div>`;
        return;
      }

      const chatIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M240-400h320v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg>`;
      const promptIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M480-360q17 0 28.5-11.5T520-400q0-17-11.5-28.5T480-440q-17 0-28.5 11.5T440-400q0 17 11.5 28.5T480-360Zm-40-160h80v-240h-80v240ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg>`;

      out.innerHTML = stages.map((s, i) => {
        const hasDiscussion = s.discussion.filter(d => d.trim()).length > 0;
        const hasPrompts = s.prompts.filter(p => p.trim()).length > 0;
        const hasQuestions = s.questions.filter(q => q.text.trim()).length > 0;

        return `
    <div class="preview-stage">
      <div class="preview-stage-header">
        <span class="preview-stage-num">Stage ${i + 1}</span>
        <span class="preview-stage-title">${escH(s.title || 'Untitled Stage')}</span>
      </div>
      <div class="preview-stage-body">
        ${s.content.trim() ? `<div style="font-size:12.5px;color:var(--text-secondary);line-height:1.7;margin-bottom:0.5rem;padding:0 0.25rem">${escH(s.content)}</div>` : ''}
        ${hasDiscussion ? `
          <div class="preview-talk">
            <div class="preview-talk-icon">${chatIcon}</div>
            <ul>${s.discussion.filter(d => d.trim()).map(d => `<li>${escH(d)}</li>`).join('')}</ul>
          </div>` : ''}
        ${hasPrompts ? `
          <div class="preview-prompt">
            <div class="preview-prompt-icon">${promptIcon}</div>
            <ul>${s.prompts.filter(p => p.trim()).map(p => `<li>${escH(p)}</li>`).join('')}</ul>
          </div>` : ''}
        ${hasQuestions ? s.questions.filter(q => q.text.trim()).map(q => `
          <div class="preview-question ${q.type === 'quiz' ? 'quiz-q' : ''}">
            <div class="preview-q-text">${escH(q.text)}</div>
            <div class="preview-answers">
              ${q.answers.filter(a => a.trim()).map(a =>
          `<span class="preview-answer ${q.type === 'quiz' && q.quiz === a ? 'correct' : ''}">${escH(a)}</span>`
        ).join('')}
            </div>
          </div>
        `).join('') : ''}
      </div>
    </div>`;
      }).join('');
    }

    /* =============================================
       TABS
       ============================================= */
    function switchTab(btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.preview-pane').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'pane-visual') buildVisualPreview();
    }

    /* =============================================
       IMPORT / EXPORT
       ============================================= */
    function openImportModal() { document.getElementById('import-modal').classList.add('open'); }
    function closeImportModal() {
      document.getElementById('import-modal').classList.remove('open');
      document.getElementById('import-status').textContent = '';
      document.getElementById('import-confirm-btn').disabled = true;
      document.getElementById('import-confirm-btn').style.opacity = '0.5';
      pendingImportData = null;
    }

    function handleModalBackdropClick(e) { if (e.target === document.getElementById('import-modal')) closeImportModal(); }

    function handleDragOver(e) { e.preventDefault(); document.getElementById('drop-zone').classList.add('dragover'); }
    function handleDragLeave() { document.getElementById('drop-zone').classList.remove('dragover'); }

    function handleDrop(e) {
      e.preventDefault();
      document.getElementById('drop-zone').classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) readImportFile(file);
    }

    function handleImportFile(e) {
      const file = e.target.files[0];
      if (file) readImportFile(file);
    }

    function readImportFile(file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        pendingImportData = e.target.result;
        document.getElementById('import-status').textContent = '✓ Ready to import: ' + file.name;
        document.getElementById('import-status').style.color = 'var(--green)';
        document.getElementById('import-confirm-btn').disabled = false;
        document.getElementById('import-confirm-btn').style.opacity = '1';
      };
      reader.readAsText(file);
    }

    function confirmImport() {
      if (!pendingImportData) return;
      parseTTXF(pendingImportData);
      closeImportModal();
    }

    function parseTTXF(text) {
      const lines = text.split(/\r?\n/);
      stages = [];
      document.getElementById('f-title').value = '';
      document.getElementById('f-author').value = '';
      document.getElementById('f-summary').value = '';
      document.getElementById('f-conclusion').value = '';

      let currentStage = null, currentArray = null, currentQuestion = null;
      let multiKey = null, multiVal = '';

      function flushMulti(target) {
        if (!multiKey || !target) return;
        target[multiKey] = multiVal.trim();
        multiKey = null; multiVal = '';
      }

      lines.forEach(line => {
        const t = line.trim();
        if (t.startsWith('//')) return;

        const isDirective = t.startsWith('! ') || t.startsWith('@ ') || t.startsWith('# ') ||
          t.startsWith('+ ') || t.startsWith('++ ') || t.startsWith('? ');

        if (multiKey && (isDirective || t === '')) {
          flushMulti(currentStage || {
            set: (k, v) => {
              if (k === 'title') document.getElementById('f-title').value = v;
              else if (k === 'author') document.getElementById('f-author').value = v;
              else if (k === 'summary') document.getElementById('f-summary').value = v;
              else if (k === 'conclusion') document.getElementById('f-conclusion').value = v;
            }
          });
          if (multiKey === null && !currentStage) { /* already flushed to inputs above */ }
        }

        if (t.startsWith('! ')) {
          const rest = t.slice(2);
          const ci = rest.indexOf(':');
          if (ci > -1) {
            const k = rest.slice(0, ci).trim();
            const v = rest.slice(ci + 1).trim();
            if (!currentStage) {
              if (k === 'title') document.getElementById('f-title').value = v;
              else if (k === 'author') document.getElementById('f-author').value = v;
              else if (k === 'summary') document.getElementById('f-summary').value = v;
              else if (k === 'conclusion') document.getElementById('f-conclusion').value = v;
              else if (currentStage) currentStage[k] = v;
            } else { currentStage[k] = v; }
          } else {
            multiKey = rest.trim(); multiVal = '';
          }
          currentArray = null; currentQuestion = null;
        } else if (t.startsWith('@ ')) {
          flushMulti(currentStage);
          currentStage = makeStage();
          currentStage.title = t.slice(2).trim();
          currentStage.id = nextId();
          stages.push(currentStage);
          currentArray = null; currentQuestion = null;
        } else if (t.startsWith('# ')) {
          currentArray = t.slice(2).trim();
          currentQuestion = null;
        } else if (t.startsWith('? ')) {
          currentQuestion = makeQuestion();
          currentQuestion.text = t.slice(2).trim();
          if (currentStage) currentStage.questions.push(currentQuestion);
          currentArray = null;
        } else if (t.startsWith('++ ') && currentQuestion) {
          const v = t.slice(3).trim();
          currentQuestion.answers.push(v);
          currentQuestion.quiz = v;
          currentQuestion.type = 'quiz';
        } else if (t.startsWith('+ ')) {
          const v = t.slice(2).trim();
          if (currentQuestion) {
            currentQuestion.answers.push(v);
          } else if (currentArray && currentStage) {
            if (!currentStage[currentArray]) currentStage[currentArray] = [];
            currentStage[currentArray].push(v);
          }
        } else if (multiKey) {
          multiVal += (multiVal ? '\n' : '') + line;
        }
      });

      // Trim placeholder empty answers from import
      stages.forEach(s => {
        s.questions.forEach(q => {
          q.answers = q.answers.filter(a => a.trim());
          if (q.answers.length < 2) while (q.answers.length < 2) q.answers.push('');
        });
      });

      renderAllStages();
      updatePreviews();
    }

    function exportTTXF() {
      const content = buildTTXF();
      const title = document.getElementById('f-title').value.trim() || 'scenario';
      const filename = title.toLowerCase().replace(/\s+/g, '-') + '.ttxf';
      const blob = new Blob([content], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(() => URL.revokeObjectURL(a.href), 5000);
    }

    function postToNewTab() {

      // Store text in localStorage
      localStorage.setItem("preview", buildTTXF());

      // Open receiver page in a new tab
      window.open("gym/", "_blank");

    }

    /* =============================================
       UTILS
       ============================================= */
    function escH(str) {
      return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function toggleMobileNav() {
      // stub for mobile nav
    }

    /* =============================================
       INIT
       ============================================= */
    updatePreviews();
  </script>
</body>

</html>