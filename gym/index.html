<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <title>TTX Gym — Dashboard</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <style>
    /* =============================================
       DESIGN TOKENS
       ============================================= */
    :root {
      --back: #141820;
      --mid: #1e2535;
      --surface: #252d3f;
      --surface-raised: #2c3650;
      --accent: #2e7de0;
      --accent-glow: rgba(46, 125, 224, 0.18);
      --accent-hover: #4a94f5;
      --green: #3ec9c8;
      --green-dark: #1a7b7a;
      --green-glow: rgba(62, 201, 200, 0.15);
      --amber: #f5a623;
      --red: #e05252;
      --text-primary: #e8ecf2;
      --text-secondary: rgba(232, 236, 242, 0.55);
      --text-muted: rgba(232, 236, 242, 0.3);
      --border: rgba(255, 255, 255, 0.07);
      --border-active: rgba(46, 125, 224, 0.5);
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
      --sidebar-width: 280px;
      --radius: 6px;
      --radius-lg: 10px;
      --font-display: 'Montserrat', sans-serif;
      --font-mono: 'DM Mono', monospace;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .hide {
      display: none !important;
    }

    html {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font-display);
      background: var(--back);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      font-size: 14px;
    }

    /* =============================================
       SCROLLBARS
       ============================================= */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(46, 125, 224, 0.4);
      border-radius: 99px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* =============================================
       LAYOUT
       ============================================= */
    #layout {
      display: flex;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    /* =============================================
       SIDEBAR / CONTROLLER
       ============================================= */
    #controller {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      height: 100vh;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      z-index: 100;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    #controller.hidden {
      transform: translateX(-100%);
    }

    #sidebar-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 0 0 1.5rem;
    }

    #logo-area {
      padding: 1.25rem 1.25rem 1rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: center;
    }

    #logo svg {
      width: 120px;
      height: auto;
      display: block;
    }

    .menu-section {
      padding: 0.75rem 1rem 0.25rem;
    }

    .menu-heading {
      font-family: var(--font-mono);
      font-size: 0.6rem;
      font-weight: 400;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-secondary);
      padding: 0.5rem 0.25rem 0.4rem;
      border-top: 1px solid var(--border);
      margin-top: 0.5rem;
    }

    .menu-heading:first-child {
      border-top: none;
      margin-top: 0;
    }

    .link {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.55rem 0.75rem;
      border-radius: var(--radius);
      cursor: pointer;
      color: var(--text-primary);
      transition: all 0.18s ease;
      font-size: 13px;
      font-weight: 500;
      user-select: none;
      position: relative;
    }

    .link:hover {
      background: var(--surface);
      color: var(--accent);
    }

    .link svg {
      flex-shrink: 0;
      fill: currentColor;
      opacity: 0.7;
      width: 18px;
      height: 18px;
    }

    .link:hover svg {
      opacity: 1;
    }

    .link.active {
      background: var(--accent-glow);
      color: var(--accent);
      border: 1px solid var(--border-active);
    }

    .link.active svg {
      opacity: 1;
      fill: var(--accent);
    }

    /* =============================================
       SCENARIO LOADER AREA
       ============================================= */
    #scenario-loader {
      padding: 0 0.25rem;
    }

    #scenario-loader-data {
      margin-bottom: 0.5rem;
    }

    #file-name {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--green);
      padding: 0.4rem 0.5rem;
      background: var(--green-glow);
      border: 1px solid rgba(62, 201, 200, 0.2);
      border-radius: var(--radius);
      margin-bottom: 0.5rem;
    }

    #file-name svg {
      fill: var(--green);
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .stat {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      padding: 0.1rem 0.5rem;
    }

    #fileInput {
      display: none;
    }

    /* =============================================
       STAGE TIMING TABLE
       ============================================= */
    .data-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3rem 0.5rem;
      border-radius: 4px;
      font-size: 12px;
    }

    .data-row:hover {
      background: var(--surface);
    }

    .data-label {
      color: var(--text-secondary);
      font-family: var(--font-mono);
      font-size: 11px;
    }

    .data-number {
      color: var(--green);
      font-family: var(--font-mono);
      font-weight: 500;
    }

    /* =============================================
       MAIN CONTENT AREA
       ============================================= */
    #scribe {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    /* Top bar */
    #topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      height: 56px;
      border-bottom: 1px solid var(--border);
      background: var(--back);
      flex-shrink: 0;
      gap: 1rem;
    }

    #hamburger {
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0.35rem 0.55rem;
      border-radius: 4px;
      color: var(--text-secondary);
      transition: all 0.15s;
      font-size: 18px;
      line-height: 1;
      border: 1px solid var(--border);
      background: var(--mid);
      font-family: inherit;
      flex-shrink: 0;
    }

    #hamburger:hover {
      background: var(--surface);
      color: var(--text-primary);
      border-color: rgba(255, 255, 255, 0.15);
    }

    #title-text {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    #topbar-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }

    /* Save indicator */
    #save-indicator {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.6rem;
      border-radius: 99px;
      transition: all 0.3s;
    }

    #save-indicator.saved {
      color: var(--green);
    }

    #save-indicator .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    /* Scroll area */
    #scribe-inner {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem 2rem;
    }

    /* =============================================
       WELCOME / EMPTY STATE
       ============================================= */
    #welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      min-height: 0;
    }

    #welcome-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 1rem;
      text-align: center;
      padding: 2rem;
    }

    #welcome-state .welcome-icon {
      width: 60px;
      height: 60px;
      border-radius: 16px;
      background: var(--accent-glow);
      border: 1px solid var(--border-active);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

    #welcome-state .welcome-icon svg {
      fill: var(--accent);
      width: 28px;
      height: 28px;
    }

    #welcome-state h2 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
    }

    #welcome-state p {
      font-size: 13px;
      color: var(--text-secondary);
      max-width: 360px;
      line-height: 1.7;
    }

    .welcome-load-btn {
      margin-top: 0.5rem;
      padding: 0.6rem 1.4rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-family: var(--font-display);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s;
    }

    .welcome-load-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    /* Syntax guide */
    .syntax-guide {
      margin-top: 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 1rem 1.25rem;
      text-align: left;
      max-width: 440px;
      width: 100%;
    }

    .syntax-guide h3 {
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--accent);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }

    .syntax-row {
      display: flex;
      gap: 0.75rem;
      align-items: baseline;
      margin-bottom: 0.4rem;
      font-size: 12px;
    }

    .syntax-key {
      font-family: var(--font-mono);
      color: var(--amber);
      font-weight: 500;
      min-width: 28px;
    }

    .syntax-desc {
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* =============================================
       ROUND / STAGE CARDS
       ============================================= */
    .round {
      margin-bottom: 0.75rem;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--surface);
      transition: border-color 0.2s, box-shadow 0.2s;
      overflow: hidden;
    }

    .round:hover {
      border-color: rgba(255, 255, 255, 0.12);
    }

    .round.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-glow), var(--shadow);
    }

    .round.complete {
      border-color: var(--green-dark);
    }

    .round.complete.active {
      border-color: var(--green);
      box-shadow: 0 0 0 1px var(--green-glow);
    }

    .sc_title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.85rem 1rem;
      background: transparent;
      cursor: pointer;
      user-select: none;
      gap: 0.75rem;
      transition: background 0.15s;
    }

    .sc_title-bar:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .round.active .sc_title-bar {
      background: rgba(46, 125, 224, 0.08);
    }

    .round.complete .sc_title-bar {
      background: rgba(62, 201, 200, 0.06);
    }

    .sc_title-left {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      min-width: 0;
    }

    .stage-badge {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 500;
      padding: 0.2rem 0.5rem;
      border-radius: 99px;
      background: var(--surface-raised);
      color: var(--text-muted);
      flex-shrink: 0;
      border: 1px solid var(--border);
      letter-spacing: 0.04em;
    }

    .round.active .stage-badge {
      background: var(--accent-glow);
      color: var(--accent);
      border-color: var(--border-active);
    }

    .round.complete .stage-badge {
      background: var(--green-glow);
      color: var(--green);
      border-color: rgba(62, 201, 200, 0.3);
    }

    .sc_title {
      font-size: 13.5px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sc_toggle-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      line-height: 1;
      flex-shrink: 0;
      transition: all 0.15s;
      margin: 0;
    }

    .sc_toggle-btn:hover {
      background: var(--surface-raised);
      color: var(--text-primary);
    }

    .sc_toggle-btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .sc_content-wrapper {
      height: 0;
      overflow: hidden;
      transition: height 0.28s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sc_content {
      padding: 1.25rem;
      border-radius: 0 0 0 4px;
      margin: 0 1rem 0.75rem;
      font-size: 13px;
      line-height: 1.7;
      color: var(--text-primary);
    }

    .sc_content p {
      margin-bottom: 0.6rem;
    }

    .sc_content p:last-child {
      margin-bottom: 0;
    }

    .sc_content strong {
      color: var(--text-primary);
    }

    .sc_content em {
      font-style: italic;
    }

    .sc_content ul,
    .sc_content ol {
      padding-left: 1.25rem;
      margin: 0.4rem 0;
    }

    .sc_content li {
      margin-bottom: 0.3rem;
    }

    .sc_content blockquote {
      padding: 0.75rem 1rem;
      margin: 0.75rem 0;
      background: rgba(30, 75, 86, 0.5);
      border-left: 3px solid var(--green);
      border-radius: 0 4px 4px 0;
    }

    .SFmedia {
      display: block;
      margin: 0.75rem auto;
      max-width: 100%;
      max-height: 300px;
      border-radius: var(--radius);
      object-fit: contain;
    }

    /* Discussion / Talk block */
    .talk {
      margin: 0 1rem 0.75rem;
      padding: 0.85rem 1rem;
      background: rgba(0, 51, 102, 0.25);
      border-left: 3px solid var(--accent);
      border-radius: 0 var(--radius) var(--radius) 0;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .talk .icon {
      flex-shrink: 0;
    }

    .talk .icon svg {
      fill: var(--accent);
      width: 18px;
      height: 18px;
      margin-top: 2px;
    }

    .talk ul {
      padding-left: 1.1rem;
      font-size: 13px;
      line-height: 1.7;
    }

    .talk ul li {
      margin-bottom: 0.3rem;
    }

    /* Facilitator prompts */
    .prompt {
      margin: 0 1rem 0.75rem;
      padding: 0.85rem 1rem;
      background: rgba(245, 166, 35, 0.06);
      border-left: 3px solid var(--amber);
      border-radius: 0 var(--radius) var(--radius) 0;
      display: flex;
      gap: 0.75rem;
      align-items: center;
    }

    .prompt .icon {
      flex-shrink: 0;
    }

    .prompt .icon svg {
      fill: var(--amber);
      width: 18px;
      height: 18px;
      margin-top: 2px;
    }

    .prompt ul {
      padding-left: 1.1rem;
      font-size: 13px;
      line-height: 1.7;
    }

    .prompt ul li {
      margin-bottom: 0.3rem;
    }

    /* Notes textarea */
    .notes-area {
      margin: 0 1rem 1rem;
    }

    .notes-label {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
      padding-left: 2px;
    }

    textarea.description {
      width: 100%;
      min-height: 80px;
      background: var(--back);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 12.5px;
      line-height: 1.6;
      padding: 0.65rem 0.85rem;
      resize: vertical;
      transition: border-color 0.18s, box-shadow 0.18s;
    }

    textarea.description:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    textarea.description:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    textarea.description::placeholder {
      color: var(--text-muted);
    }

    /* =============================================
       QUESTIONS
       ============================================= */
    .question {
      margin: 0 1rem 0.85rem;
      padding: 0.85rem 1rem;
      background: var(--surface-raised);
      border: 1px solid var(--border);
      border-left: 3px solid var(--accent);
      border-radius: var(--radius);
    }

    .question.question-quiz {
      border-left-color: var(--green);
    }

    .question-type-badge {
      display: inline-block;
      font-size: 10px;
      font-family: var(--font-mono);
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 0.15rem 0.45rem;
      border-radius: 99px;
      margin-bottom: 0.45rem;
    }

    .question-type-badge.rating {
      background: rgba(46, 125, 224, 0.12);
      color: var(--accent);
      border: 1px solid rgba(46, 125, 224, 0.25);
    }

    .question-type-badge.quiz {
      background: var(--green-glow);
      color: var(--green);
      border: 1px solid rgba(62, 201, 200, 0.3);
    }

    .question-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.65rem;
      line-height: 1.5;
    }

    .choices {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .choice {
      display: flex;
      align-items: center;
    }

    .choice input[type="radio"] {
      position: fixed;
      width: 0;
      height: 0;
      opacity: 0;
      pointer-events: none;
    }

    .choice label {
      font-size: 12.5px;
      font-style: italic;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.35rem 0.75rem;
      border-radius: 99px;
      border: 1px solid var(--border);
      background: var(--surface);
      transition: all 0.15s;
      user-select: none;
    }

    .choice label:hover {
      border-color: var(--accent);
      color: var(--text-primary);
      background: var(--accent-glow);
    }

    /* Inactive rounds — suppress hover to signal non-interactivity */
    .round:not(.active) .choice label {
      cursor: not-allowed;
      opacity: 0.5;
    }

    .round:not(.active) .choice label:hover {
      border-color: var(--border);
      color: var(--text-secondary);
      background: var(--surface);
    }

    .choice input[type="radio"]:checked+label {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
      font-weight: 600;
    }

    .choice input[type="radio"]:focus-visible+label {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Quiz feedback */
    .quiz-feedback {
      margin-top: 0.5rem;
      font-size: 12px;
      font-family: var(--font-mono);
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius);
      display: none;
    }

    .quiz-feedback.correct {
      display: block;
      background: var(--green-glow);
      border: 1px solid rgba(62, 201, 200, 0.3);
      color: var(--green);
    }

    .quiz-feedback.incorrect {
      display: block;
      background: rgba(224, 82, 82, 0.1);
      border: 1px solid rgba(224, 82, 82, 0.3);
      color: var(--red);
    }

    /* =============================================
       FOOTER / STAGE NAVIGATION
       ============================================= */
    #footer {
      border-top: 1px solid var(--border);
      background: var(--mid);
      flex-shrink: 0;
    }

    .footer-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 1rem;
      height: 52px;
      gap: 0;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .footer-bar::-webkit-scrollbar {
      display: none;
    }

    .stage {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.18s;
      flex-shrink: 0;
    }

    .stage svg {
      fill: currentColor;
      width: 16px;
      height: 16px;
    }

    .stage:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    .stage.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .stage.complete {
      background: var(--green-glow);
      border-color: var(--green-dark);
      color: var(--green);
    }

    .stage.complete.active {
      background: var(--green);
      border-color: var(--green);
      color: var(--back);
      box-shadow: 0 0 0 3px var(--green-glow);
    }

    .connector {
      flex: 1;
      height: 1px;
      background: var(--border);
      min-width: 8px;
      max-width: 32px;
    }

    .link#previous,
    .link#next {
      flex-shrink: 0;
      padding: 0.35rem 0.75rem;
      border-radius: var(--radius);
      background: var(--surface);
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.35rem;
      transition: all 0.18s;
    }

    .link#previous {
      margin-right: 0.75rem;
    }

    .link#next {
      margin-left: 0.75rem;
    }

    .link#previous:hover,
    .link#next:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
    }

    .link#previous svg,
    .link#next svg {
      fill: currentColor;
      width: 14px;
      height: 14px;
    }

    .link.hidden {
      display: none !important;
    }

    /* =============================================
       SUMMARY OVERLAY
       ============================================= */
    #summary-overlay {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      bottom: 0;
      z-index: 490;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(20, 24, 32, 0.88);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      padding: 2rem;
    }

    #summary-overlay.hidden-overlay {
      display: none;
    }

    @media (max-width: 768px) {
      #summary-overlay {
        left: 0;
        padding: 1rem;
      }
    }

    #summary-overlay-card {
      background: var(--mid);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 680px;
      max-height: 88vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #summary-overlay-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.1rem 1.4rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    #summary-overlay-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    #summary-close-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.25rem 0.6rem;
      border-radius: var(--radius);
      font-size: 14px;
      cursor: pointer;
      line-height: 1;
      transition: all 0.15s;
    }

    #summary-close-btn:hover {
      background: var(--surface-raised);
      color: var(--text-primary);
    }

    #summary-overlay-body {
      overflow-y: auto;
      padding: 1.25rem 1.4rem;
      flex: 1;
    }

    #summary-overlay-body ul {
      padding-bottom: 1rem;
    }

    /* =============================================
       PAUSE OVERLAY
       ============================================= */
    #pause {
      position: fixed;
      top: 0;
      left: var(--sidebar-width);
      right: 0;
      bottom: 0;
      z-index: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(20, 24, 32, 0.85);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }

    @media (max-width: 768px) {
      #pause {
        left: 0;
      }
    }

    #pause.hidden-overlay {
      display: none;
    }

    .overlay-message {
      background: var(--mid);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 2.5rem 3rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      box-shadow: var(--shadow);
      text-align: center;
    }

    .overlay-message svg {
      fill: var(--text-secondary);
      width: 40px;
      height: 40px;
    }

    .overlay-message h2 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .overlay-message p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* =============================================
       BUTTONS
       ============================================= */
    button {
      font-family: var(--font-display);
      font-size: 13px;
      font-weight: 600;
      padding: 0.5rem 1.1rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.18s;
      margin: 0;
    }

    button:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
    }

    button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    button.primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
      color: #fff;
    }

    /* =============================================
       PARSE ERROR BANNER
       ============================================= */
    #parse-error {
      display: none;
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(224, 82, 82, 0.1);
      border: 1px solid rgba(224, 82, 82, 0.3);
      border-radius: var(--radius);
      color: var(--red);
      font-size: 12.5px;
      line-height: 1.6;
    }

    #parse-error.visible {
      display: block;
    }

    /* =============================================
       REPORT HIDDEN BUTTON
       ============================================= */
    /* reporter button removed - summary triggered by direct JS */

    /* Sidebar collapses on desktop too via .collapsed class */
    #controller.collapsed {
      transform: translateX(-100%);
      min-width: 0;
      width: 0;
      border-right: none;
    }

    /* =============================================
       RESPONSIVE / MOBILE
       ============================================= */
    @media (max-width: 768px) {
      :root {
        --sidebar-width: 85vw;
      }

      #controller {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        transform: translateX(-100%);
        z-index: 200;
        box-shadow: 4px 0 32px rgba(0, 0, 0, 0.5);
        min-width: var(--sidebar-width);
        width: var(--sidebar-width);
      }

      #controller.show {
        transform: translateX(0);
      }

      #controller.collapsed {
        transform: translateX(-100%);
      }

      #scribe-inner {
        padding: 1rem;
      }

      #sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 199;
      }

      #sidebar-overlay.active {
        display: block;
      }

      #pause {
        left: 0;
      }
    }

    .outer {
      display: flex;
      justify-content: center;
      margin: 1rem 0;
    }

    .chart-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem;
      min-width: 280px;
    }

    .bchart {
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      justify-content: center;
      height: 160px;
    }

    .bar {
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      min-width: 50px;
      width: 60px;
      height: 160px;
      text-align: center;
      flex-shrink: 0;
    }

    .bar-inner {
      border-radius: 4px 4px 0 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 4px;
    }

    .bar-label {
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      font-family: var(--font-mono);
    }

    .x-axis-label {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-secondary);
      font-family: var(--font-mono);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 60px;
    }

    .dchart {
      display: flex;
      height: 24px;
      border-radius: 4px;
      overflow: hidden;
      margin: 0.25rem 0;
      min-height: 24px;
    }

    .segment {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 11px;
      font-weight: 600;
      font-family: var(--font-mono);
    }

    .chart-title {
      display: flex;
      justify-content: space-evenly;
      margin-top: 0.25rem;
    }

    .chart-title div {
      flex: 1;
      text-align: center;
    }

    .outer h3 {
      margin: 0;
      font-size: 12px;
      color: var(--text-secondary);
    }
  </style>
</head>

<body>
  <div id="sidebar-overlay" onclick="closeSidebar()"></div>

  <div id="layout">
    <!-- ===== SIDEBAR ===== -->
    <nav id="controller" aria-label="Session controls">
      <div id="sidebar-scroll">
        <div id="logo-area">
          <a href="https://www.ttxgym.com" aria-label="TTX Gym Home">
            <div id="logo">
              <svg viewBox="0 0 210 84" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <g>
                  <path style="fill:#ffffff;stroke-width:0.144177"
                    d="m 123.95944,30.43245 0.001,-1.117375 5.11724,-6.112717 c 2.81453,-3.361993 5.11729,-6.171028 5.11729,-6.242298 0,-0.07123 -2.30323,-2.881476 -5.1183,-6.244894 l -5.1183,-6.1153013 v -1.086954 -1.086943 l 3.28003,0.0063 3.28005,0.0063 3.8207,4.544782 c 2.10139,2.499633 3.91803,4.6295583 4.03697,4.7331703 0.18592,0.161956 0.77129,-0.476686 4.17186,-4.5515563 l 3.95559,-4.739934 h 3.28934 3.28932 v 1.052384 1.052384 l -5.19039,6.1834383 c -2.85472,3.400899 -5.1886,6.219979 -5.18639,6.264626 0.002,0.04464 2.33524,2.838581 5.18451,6.208731 l 5.18051,6.127543 0.006,1.117375 0.006,1.117376 -3.28004,-0.0032 -3.28003,-0.0032 -4.03542,-4.764205 c -3.77303,-4.454434 -4.04959,-4.7469 -4.25324,-4.498099 -0.1198,0.146359 -1.92418,2.291532 -4.00975,4.767043 l -3.792,4.500917 h -3.23672 -3.23673 l 0.001,-1.117376 z" />
                  <path style="fill:#ffffff;stroke-width:0.144177"
                    d="M 103.62935,20.159802 V 8.7697787 h -5.767107 -5.767099 v -3.171906 -3.171905 h 14.634016 14.63402 v 3.171905 3.171906 h -5.69501 -5.69501 V 20.159802 31.549826 h -3.1719 -3.17191 z" />
                  <path style="fill:#ffffff;stroke-width:0.144177"
                    d="M 71.045229,20.159802 V 8.7697787 h -5.695017 -5.695007 v -3.171906 -3.171905 h 14.561929 14.561929 v 3.171905 3.171906 H 83.084046 77.38904 V 20.159802 31.549826 h -3.171906 -3.171905 z" />
                  <path style="fill:#1a6ec0;fill-opacity:1;stroke-width:0.139424"
                    d="m 56.568246,44.749266 c 0.132103,-1.130608 0.11982,-5.393817 -0.01826,-6.336905 l -0.09381,-0.640428 h 50.057284 50.05728 l -0.0914,0.775254 c -0.14125,1.198686 -0.15482,4.546774 -0.0241,5.932418 l 0.1177,1.247158 H 106.51352 56.453986 Z" />
                  <path style="fill:#1a6ec0;stroke-width:0.144177;fill-opacity:1"
                    d="m 200.94868,51.986986 c 0,-0.01984 -0.19934,-0.522652 -0.44235,-1.117376 -0.24303,-0.594734 -0.62663,-1.835993 -0.85249,-2.758363 -1.17752,-4.80902 -0.86406,-9.679602 0.90117,-14.002281 l 0.57405,-1.405726 h 4.0357 4.03569 l -0.26157,0.39649 c -1.23002,1.864399 -2.0063,3.624311 -2.54655,5.77324 -0.26627,1.059149 -0.3139,1.638572 -0.30464,3.706429 0.0142,3.191363 0.30209,4.354515 1.81632,7.340458 l 1.06655,2.103165 h -4.01068 c -2.20589,0 -4.01093,-0.01625 -4.0112,-0.03609 z" />
                  <path style="fill:#1a6ec0;fill-opacity:1;stroke-width:0.144177"
                    d="m 3.0885296,51.941186 c 0,-0.04506 0.44678,-0.969549 0.99284,-2.054529 1.56297,-3.105469 1.81674,-4.159426 1.81148,-7.523519 -0.003,-2.117705 -0.0453,-2.529327 -0.38251,-3.748616 -0.62502,-2.259971 -1.27274,-3.70054 -2.47959,-5.514785 l -0.26374,-0.396489 h 4.03913 4.0391284 l 0.508459,1.214635 c 1.175244,2.807495 1.592501,5.008816 1.600805,8.445255 0.0084,3.455866 -0.441579,6.004916 -1.515078,8.583574 l -0.448069,1.076317 H 7.0399596 c -2.17329,0 -3.95143,-0.03683 -3.95143,-0.08188 z" />
                  <path style="fill:#1a6ec0;stroke-width:0.144177;fill-opacity:1"
                    d="m 188.14448,64.45835 c -4.60694,-9.066036 -6.34795,-19.950671 -4.79103,-29.952887 0.79263,-5.092105 2.34256,-10.128325 4.37061,-14.201486 l 0.75375,-1.513865 5.15491,-0.03788 5.15492,-0.03788 -1.44187,2.36676 c -1.68405,2.764325 -2.62234,4.771433 -3.60217,7.705364 -1.48568,4.448683 -2.16923,8.595656 -2.16312,13.123333 0.0109,8.068699 2.41694,16.120002 6.77075,22.656654 0.44893,0.674024 0.86412,1.306609 0.92263,1.405726 0.0843,0.142814 -0.97051,0.180221 -5.08108,0.180221 h -5.18744 z" />
                  <path style="fill:#1a6ec0;fill-opacity:1;stroke-width:0.144177"
                    d="M 13.442562,64.890886 C 21.430959,52.97521 22.612598,37.550731 16.537975,24.485129 16.224594,23.811095 15.34227,22.237758 14.577265,20.988827 L 13.186333,18.71803 h 5.166097 5.166087 l 0.803415,1.698254 c 5.365207,11.340999 6.308978,24.008992 2.687685,36.076248 -0.753947,2.512395 -1.94733,5.507012 -3.117002,7.821643 l -0.928945,1.838262 h -5.183434 -5.183435 z" />
                  <path style="fill:#1a6ec0;stroke-width:0.144177;fill-opacity:1"
                    d="m 174.53173,78.948193 c -5.15518,-8.267119 -8.66247,-19.326858 -9.79592,-30.890037 -0.24331,-2.48236 -0.24156,-10.536496 0.003,-12.975982 1.12233,-11.203007 4.06279,-20.780917 9.1843,-29.9160563 l 1.53618,-2.74015 h 5.47631 5.47631 l -0.49924,0.68484 c -2.41341,3.310656 -5.29765,8.4418153 -7.00382,12.4600833 -6.83569,16.098892 -7.07266,34.022086 -0.66592,50.365278 1.74301,4.446298 4.74992,9.997815 7.52608,13.895014 0.41656,0.58477 0.72226,1.12003 0.67935,1.18946 -0.0429,0.0694 -2.43321,0.12626 -5.31175,0.12626 h -5.23371 z" />
                  <path style="fill:#ffffff;stroke-width:0.144177"
                    d="M 121.65153,67.017498 V 52.888101 l 3.13587,5.7e-4 3.13586,5.8e-4 3.17191,3.780699 c 1.74455,2.079391 3.89837,4.64314 4.78628,5.697244 l 1.61436,1.916538 4.77081,-5.697761 4.77081,-5.69787 h 3.16659 3.16657 v 14.129397 14.129405 h -3.09878 -3.09876 l -0.0371,-9.382769 -0.037,-9.382768 -4.75785,5.697085 c -2.61683,3.1334 -4.7903,5.700884 -4.82996,5.705506 -0.0397,0.0042 -2.24556,-2.565511 -4.90203,-5.711405 l -4.82995,-5.719804 -0.037,9.397077 -0.0371,9.397078 h -3.02668 -3.02669 z" />
                  <path style="fill:#ffffff;stroke-width:0.144177"
                    d="m 100.45743,75.865912 v -5.280979 l -1.344169,-1.819764 c -0.739298,-1.000858 -3.6589,-4.950452 -6.487984,-8.776859 -2.829095,-3.826422 -5.143811,-6.989316 -5.143811,-7.028665 0,-0.03936 1.617879,-0.07154 3.595271,-0.07154 h 3.595282 l 4.42039,5.550836 c 2.431221,3.05296 4.432961,5.550842 4.448301,5.550842 0.0153,0 2.00418,-2.497006 4.41964,-5.54889 l 4.39174,-5.548884 3.64048,-0.0021 c 2.00227,-0.001 3.64048,0.03218 3.64048,0.07376 0,0.04168 -1.83591,2.555739 -4.0798,5.586882 -2.24389,3.031139 -5.16348,6.979234 -6.48798,8.773567 l -2.40819,3.262401 v 5.280114 5.2801 h -3.09983 -3.09982 z" />
                  <path style="fill:#ffffff;stroke-width:0.144177"
                    d="m 62.502123,80.992853 c -1.603358,-0.38525 -3.146168,-1.67929 -3.90041,-3.2715 l -0.460373,-0.97187 v -9.731985 -9.731983 l 0.47064,-0.962093 c 0.817123,-1.670376 2.149173,-2.774973 3.881596,-3.2188 0.768181,-0.196799 2.098574,-0.22127 10.08887,-0.185561 9.200985,0.04115 9.204277,0.04126 10.016894,0.369845 1.187347,0.480148 2.594836,1.823046 3.180052,3.034115 0.444291,0.91942 0.467685,1.054456 0.522915,3.017034 l 0.05783,2.05453 h -3.115852 -3.115852 v -1.153422 -1.153422 h -8.003075 -8.003064 l 0.03725,7.965804 0.03725,7.965814 7.965804,0.03725 7.965804,0.03725 v -2.163882 -2.163893 h -3.027719 -3.02773 v -3.02772 -3.02773 h 6.134855 6.134866 l -0.04337,6.019414 -0.04337,6.019405 -0.463865,0.94788 c -0.594481,1.21481 -1.698782,2.31911 -2.913576,2.91359 l -0.947886,0.46386 -9.443633,0.0241 c -5.211651,0.0133 -9.686177,-0.0342 -9.984879,-0.106 z" />
                  <path style="fill:#1a6ec0;fill-opacity:1;stroke-width:0.144177"
                    d="m 25.519705,81.021453 c -0.0439,-0.071 0.03978,-0.28263 0.185983,-0.47036 1.311927,-1.68534 3.639855,-5.502462 5.220114,-8.559464 C 37.220777,59.814061 39.557125,45.873306 37.606851,32.126537 36.200366,22.212685 32.499604,12.59703 26.939043,4.4084047 l -1.3462,-1.982437 5.436392,0.0021 5.436382,0.0021 1.40982,2.557101 c 2.522363,4.575035 4.243812,8.5214633 5.769337,13.2262383 6.107588,18.835993 4.615545,39.223717 -4.167783,56.950123 -0.589373,1.189457 -1.607315,3.006103 -2.262092,4.036963 l -1.190513,1.87431 -5.212463,0.0379 c -2.957294,0.0214 -5.24697,-0.0179 -5.292218,-0.0912 z" />
                </g>
              </svg>
            </div>
          </a>
        </div>

        <div class="menu-section">
          <div class="menu-heading">Scenario</div>
          <div id="scenario-loader">
            <div id="scenario-loader-data"></div>
            <input type="file" id="fileInput" accept=".ttxf,.txt" aria-label="Load scenario file" />
          </div>
          <div class="link" onclick="fileInput.click();" role="button" tabindex="0" aria-label="Load Scenario file"
            onkeydown="if(event.key==='Enter'||event.key===' ')fileInput.click()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v268q-19-9-39-15.5t-41-9.5v-243H200v560h242q3 22 9.5 42t15.5 38H200Zm0-120v40-560 243-3 280Zm80-40h163q3-21 9.5-41t14.5-39H280v80Zm0-160h244q32-30 71.5-50t84.5-27v-3H280v80Zm0-160h400v-80H280v80ZM720-40q-83 0-141.5-58.5T520-240q0-83 58.5-141.5T720-440q83 0 141.5 58.5T920-240q0 83-58.5 141.5T720-40Zm-20-80h40v-100h100v-40H740v-100h-40v100H600v40h100v100Z" />
            </svg>
            Load Scenario
          </div>
          <div id="restart" class="hide link" onclick="exportScenario()" role="button" tabindex="0"
            onkeydown="if(event.key==='Enter')exportScenario()" aria-label="Download scenario file">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="m648-140 112-112v92h40v-160H640v40h92L620-168l28 28Zm-448 20q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v268q-19-9-39-15.5t-41-9.5v-243H200v560h242q3 22 9.5 42t15.5 38H200Zm0-120v40-560 243-3 280Zm80-40h163q3-21 9.5-41t14.5-39H280v80Zm0-160h244q32-30 71.5-50t84.5-27v-3H280v80Zm0-160h400v-80H280v80ZM720-40q-83 0-141.5-58.5T520-240q0-83 58.5-141.5T720-440q83 0 141.5 58.5T920-240q0 83-58.5 141.5T720-40Z" />
            </svg>
            Download Scenario File
          </div>
          <div id="report-export" class="hide link" onclick="exportReport()" role="button" tabindex="0"
            onkeydown="if(event.key==='Enter')exportReport()" aria-label="Export exercise report">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M480-320 280-520l56-58 104 104v-326h80v326l104-104 56 58-200 200ZM240-160q-33 0-56.5-23.5T160-240v-120h80v120h480v-120h80v120q0 33-23.5 56.5T720-160H240Z" />
            </svg>
            Export Report
          </div>
          <div id="scenario-reset" class="hide link" onclick="confirmResetScenario()" role="button" tabindex="0"
            onkeydown="if(event.key==='Enter')confirmResetScenario()" aria-label="Reset scenario">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M440-122q-121-15-200.5-105.5T160-440q0-66 26-126t72-106l57 57q-38 34-56.5 79T240-440q0 88 56 153t144 80v85Zm80 0v-85q87-15 143.5-80T720-440q0-100-70-170t-170-70h-3l44 44-56 56-140-140 140-140 56 57-44 43h3q134 0 227 93t93 227q0 121-79.5 211.5T520-122Z" />
            </svg>
            Reset Scenario
          </div>
          <div id="clear-answers" class="hide link" onclick="clearAllAnswers()" role="button" tabindex="0"
            onkeydown="if(event.key==='Enter')clearAllAnswers()" aria-label="Clear all question answers">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z" />
            </svg>
            Clear All Answers
          </div>
        </div>

        <div class="menu-section">
          <div class="menu-heading hide">Participant Window</div>
          <div id="launcher" class="hide link" onclick="launchPresentation()" role="button" tabindex="0"
            aria-label="Launch participant window">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M320-400h80v-80q0-17 11.5-28.5T440-520h80v80l120-120-120-120v80h-80q-50 0-85 35t-35 85v80ZM160-240q-33 0-56.5-23.5T80-320v-440q0-33 23.5-56.5T160-840h640q33 0 56.5 23.5T880-760v440q0 33-23.5 56.5T800-240H160Zm0-80h640v-440H160v440Zm0 0v-440 440ZM40-120v-80h880v80H40Z" />
            </svg>
            Launch
          </div>
          <div id="report-launcher" class="hide link" onclick="handleFormSubmit()" role="button" tabindex="0"
            aria-label="Present summary">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M80-600v-160q0-33 23.5-56.5T160-840h640q33 0 56.5 23.5T880-760v160h-80v-160H160v160H80Zm80 360q-33 0-56.5-23.5T80-320v-200h80v200h640v-200h80v200q0 33-23.5 56.5T800-240H160ZM40-120v-80h880v80H40Zm440-420ZM80-520v-80h240q11 0 21 6t15 16l47 93 123-215q5-9 14-14.5t20-5.5q11 0 21 5.5t15 16.5l49 98h235v80H620q-11 0-21-5.5T584-542l-26-53-123 215q-5 10-15 15t-21 5q-11 0-20.5-6T364-382l-69-138H80Z" />
            </svg>
            Present Summary
          </div>
        </div>

        <div class="menu-section">
          <div class="menu-heading hide">Exercise Status</div>
          <div id="times-header" class="hide link" aria-label="Stage durations">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M360-840v-80h240v80H360Zm80 440h80v-240h-80v240Zm40 320q-74 0-139.5-28.5T226-186q-49-49-77.5-114.5T120-440q0-74 28.5-139.5T226-694q49-49 114.5-77.5T480-800q62 0 119 20t107 58l56-56 56 56-56 56q38 50 58 107t20 119q0 74-28.5 139.5T734-186q-49 49-114.5 77.5T480-80Zm0-80q116 0 198-82t82-198q0-116-82-198t-198-82q-116 0-198 82t-82 198q0 116 82 198t198 82Zm0-280Z" />
            </svg>
            Stage Duration
          </div>
          <div id="times" role="list" aria-label="Stage timing"></div>
          <div id="timer" class="hide link" onclick="toggleTimer()" role="button" tabindex="0"
            onkeydown="if(event.key==='Enter')toggleTimer()" aria-label="Toggle exercise timer">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M320-320h80v-320h-80v320Zm160 0 240-160-240-160v320Zm0 240q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z" />
            </svg>
            <span class="indent">Exercise Ready</span>
          </div>
          <div id="fullscreen-control" class="link" onclick="toggleFullscreen()" role="button" tabindex="0"
            onkeydown="if(event.key==='Enter')toggleFullscreen()" aria-label="Toggle fullscreen">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
              <path
                d="M560-280h200v-200h-80v120H560v80ZM200-480h80v-120h120v-80H200v200Zm-40 320q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm0-80h640v-480H160v480Zm0 0v-480 480Z" />
            </svg>
            Toggle Fullscreen
          </div>
        </div>
      </div>
    </nav>

    <!-- ===== MAIN AREA ===== -->
    <main id="scribe" aria-label="Exercise session">
      <header id="topbar">
        <button id="hamburger" onclick="toggleSidebar()" aria-label="Toggle sidebar" aria-expanded="true">☰</button>
        <div id="title-text" aria-live="polite"></div>
        <div id="topbar-actions">
          <div id="save-indicator" aria-live="polite" role="status">
            <div class="dot"></div>
            <span>Saved</span>
          </div>
        </div>
      </header>

      <!-- Welcome state — shown until a scenario is loaded -->
      <div id="welcome-screen">
        <div id="welcome-state">
          <div class="welcome-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
              <path
                d="M320-400h80v-80q0-17 11.5-28.5T440-520h80v80l120-120-120-120v80h-80q-50 0-85 35t-35 85v80ZM160-240q-33 0-56.5-23.5T80-320v-440q0-33 23.5-56.5T160-840h640q33 0 56.5 23.5T880-760v440q0 33-23.5 56.5T800-240H160Zm0-80h640v-440H160v440Zm0 0v-440 440ZM40-120v-80h880v80H40Z" />
            </svg>
          </div>
          <h2>Ready to Run</h2>
          <p>Load a <code
              style="font-family:var(--font-mono);font-size:12px;background:var(--surface);padding:2px 6px;border-radius:4px;">.ttxf</code>
            scenario file to begin your tabletop exercise session.</p>
          <button class="welcome-load-btn" onclick="fileInput.click()">Load Scenario File</button>

        </div>
      </div>

      <div id="scribe-inner" class="hide">
        <div id="parse-error" role="alert"></div>
        <div id="questionsContainer" role="list" aria-label="Exercise stages">
          <!-- Stages populated by JS -->
        </div>
      </div>

      <footer id="footer" class="hide" aria-label="Stage navigation">
        <div class="footer-bar" id="stageWrapper" role="navigation" aria-label="Stage progress"></div>
      </footer>

      <div id="pause" class="hidden-overlay" role="dialog" aria-modal="true" aria-label="Exercise paused">
        <div class="overlay-message">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true">
            <path
              d="M360-320h80v-320h-80v320Zm160 0h80v-320h-80v320ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z" />
          </svg>
          <h2>Exercise Paused</h2>
          <p>Click "Resume" in the sidebar to continue</p>
        </div>
      </div>

      <!-- Summary overlay (hidden until triggered) -->
      <div id="summary-overlay" class="hidden-overlay" role="dialog" aria-modal="true" aria-label="Exercise summary">
        <div id="summary-overlay-card">
          <div id="summary-overlay-header">
            <h2 id="summary-overlay-title">Exercise Summary</h2>
            <button id="summary-close-btn" onclick="closeSummaryOverlay()" aria-label="Close summary">✕</button>
          </div>
          <div id="summary-overlay-body"></div>
        </div>
      </div>
    </main>

  </div>

  <script>
    /* =============================================
       REPORT HTML TEMPLATES
       ============================================= */
    const REPORT_CSS = `
@import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap');
*{box-sizing:border-box}
body{font-family:"m",Arial,sans-serif;margin:0;padding:2rem;background:#f8f9fb;color:#1a1f2e;font-size:14px}
#headerRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:2px solid #e2e8f0}
#logo{width:130px;flex-shrink:0}
#report-title{font-family:"Montserrat",sans-serif;font-size:22px;font-weight:800;color:#1a1f2e;text-align:right;line-height:1.3}
h1,h2,h3{font-family:"Montserrat",sans-serif}
h2{margin:1.5rem 0 0.5rem;font-size:18px}
h3{font-size:14px;margin:1rem 0 0.4rem;color:#2e7de0}
#helper{background:#fff3cd;border:1px solid #f0a500;border-radius:6px;color:#6b4c00;padding:1rem 1.25rem;margin:1rem 0;font-size:13px}
#helper a{color:#2e7de0}
#content{background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:1.5rem 2rem;margin-top:1rem}
ul{padding-left:1.25rem}
li{margin-bottom:0.4rem;line-height:1.6}
p{margin:0 0 0.75rem;line-height:1.7}
.outer{display:flex;justify-content:center;margin:1.5rem 0}
.chart-container{display:flex;flex-direction:column;gap:0.75rem;padding:1rem;min-width:340px}
.bchart{display:flex;align-items:flex-end;gap:6px;justify-content:center;height:160px}
.bar{display:flex;flex-direction:column;justify-content:flex-end;min-width:50px;height:100%;text-align:center}
.bar-inner{border-radius:4px 4px 0 0;display:flex;align-items:center;justify-content:center;print-color-adjust:exact;-webkit-print-color-adjust:exact}
.bar-label{font-size:11px;font-weight:700;color:#1a1f2e}
.x-axis-label{margin-top:4px;font-size:11px;color:#666}
.dchart{display:flex;height:24px;border-radius:4px;overflow:hidden;margin:0.25rem 0}
.segment{display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;font-weight:600;print-color-adjust:exact;-webkit-print-color-adjust:exact}
.chart-title{display:flex;justify-content:space-evenly;font-size:12px;color:#666;margin-top:0.25rem}
[contenteditable]{outline:none}
@media print{#helper{display:none}body{background:#fff;padding:0}}
`;

    const REPORT_HEADER = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="google" content="notranslate">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <title>Exercise Report</title>
  <style>${REPORT_CSS}</style>
</head>
<body>
<div id="headerRow">
  <div id="logo">
    <svg viewBox="0 0 210 84" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <g>
        <path style="fill:#1a1f2e;stroke-width:0.144177" d="m 123.95944,30.43245 0.001,-1.117375 5.11724,-6.112717 c 2.81453,-3.361993 5.11729,-6.171028 5.11729,-6.242298 0,-0.07123 -2.30323,-2.881476 -5.1183,-6.244894 l -5.1183,-6.1153013 v -1.086954 -1.086943 l 3.28003,0.0063 3.28005,0.0063 3.8207,4.544782 c 2.10139,2.499633 3.91803,4.6295583 4.03697,4.7331703 0.18592,0.161956 0.77129,-0.476686 4.17186,-4.5515563 l 3.95559,-4.739934 h 3.28934 3.28932 v 1.052384 1.052384 l -5.19039,6.1834383 c -2.85472,3.400899 -5.1886,6.219979 -5.18639,6.264626 0.002,0.04464 2.33524,2.838581 5.18451,6.208731 l 5.18051,6.127543 0.006,1.117375 0.006,1.117376 -3.28004,-0.0032 -3.28003,-0.0032 -4.03542,-4.764205 c -3.77303,-4.454434 -4.04959,-4.7469 -4.25324,-4.498099 -0.1198,0.146359 -1.92418,2.291532 -4.00975,4.767043 l -3.792,4.500917 h -3.23672 -3.23673 l 0.001,-1.117376 z"/>
        <path style="fill:#1a1f2e;stroke-width:0.144177" d="M 103.62935,20.159802 V 8.7697787 h -5.767107 -5.767099 v -3.171906 -3.171905 h 14.634016 14.63402 v 3.171905 3.171906 h -5.69501 -5.69501 V 20.159802 31.549826 h -3.1719 -3.17191 z"/>
        <path style="fill:#1a1f2e;stroke-width:0.144177" d="M 71.045229,20.159802 V 8.7697787 h -5.695017 -5.695007 v -3.171906 -3.171905 h 14.561929 14.561929 v 3.171905 3.171906 H 83.084046 77.38904 V 20.159802 31.549826 h -3.171906 -3.171905 z"/>
        <path style="fill:#1a6ec0;fill-opacity:1;stroke-width:0.139424" d="m 56.568246,44.749266 c 0.132103,-1.130608 0.11982,-5.393817 -0.01826,-6.336905 l -0.09381,-0.640428 h 50.057284 50.05728 l -0.0914,0.775254 c -0.14125,1.198686 -0.15482,4.546774 -0.0241,5.932418 l 0.1177,1.247158 H 106.51352 56.453986 Z"/>
        <path style="fill:#1a6ec0;stroke-width:0.144177;fill-opacity:1" d="m 200.94868,51.986986 c 0,-0.01984 -0.19934,-0.522652 -0.44235,-1.117376 -0.24303,-0.594734 -0.62663,-1.835993 -0.85249,-2.758363 -1.17752,-4.80902 -0.86406,-9.679602 0.90117,-14.002281 l 0.57405,-1.405726 h 4.0357 4.03569 l -0.26157,0.39649 c -1.23002,1.864399 -2.0063,3.624311 -2.54655,5.77324 -0.26627,1.059149 -0.3139,1.638572 -0.30464,3.706429 0.0142,3.191363 0.30209,4.354515 1.81632,7.340458 l 1.06655,2.103165 h -4.01068 c -2.20589,0 -4.01093,-0.01625 -4.0112,-0.03609 z"/>
        <path style="fill:#1a6ec0;fill-opacity:1;stroke-width:0.144177" d="m 3.0885296,51.941186 c 0,-0.04506 0.44678,-0.969549 0.99284,-2.054529 1.56297,-3.105469 1.81674,-4.159426 1.81148,-7.523519 -0.003,-2.117705 -0.0453,-2.529327 -0.38251,-3.748616 -0.62502,-2.259971 -1.27274,-3.70054 -2.47959,-5.514785 l -0.26374,-0.396489 h 4.03913 4.0391284 l 0.508459,1.214635 c 1.175244,2.807495 1.592501,5.008816 1.600805,8.445255 0.0084,3.455866 -0.441579,6.004916 -1.515078,8.583574 l -0.448069,1.076317 H 7.0399596 c -2.17329,0 -3.95143,-0.03683 -3.95143,-0.08188 z"/>
        <path style="fill:#1a6ec0;stroke-width:0.144177;fill-opacity:1" d="m 188.14448,64.45835 c -4.60694,-9.066036 -6.34795,-19.950671 -4.79103,-29.952887 0.79263,-5.092105 2.34256,-10.128325 4.37061,-14.201486 l 0.75375,-1.513865 5.15491,-0.03788 5.15492,-0.03788 -1.44187,2.36676 c -1.68405,2.764325 -2.62234,4.771433 -3.60217,7.705364 -1.48568,4.448683 -2.16923,8.595656 -2.16312,13.123333 0.0109,8.068699 2.41694,16.120002 6.77075,22.656654 0.44893,0.674024 0.86412,1.306609 0.92263,1.405726 0.0843,0.142814 -0.97051,0.180221 -5.08108,0.180221 h -5.18744 z"/>
        <path style="fill:#1a6ec0;fill-opacity:1;stroke-width:0.144177" d="M 13.442562,64.890886 C 21.430959,52.97521 22.612598,37.550731 16.537975,24.485129 16.224594,23.811095 15.34227,22.237758 14.577265,20.988827 L 13.186333,18.71803 h 5.166097 5.166087 l 0.803415,1.698254 c 5.365207,11.340999 6.308978,24.008992 2.687685,36.076248 -0.753947,2.512395 -1.94733,5.507012 -3.117002,7.821643 l -0.928945,1.838262 h -5.183434 -5.183435 z"/>
        <path style="fill:#1a6ec0;stroke-width:0.144177;fill-opacity:1" d="m 174.53173,78.948193 c -5.15518,-8.267119 -8.66247,-19.326858 -9.79592,-30.890037 -0.24331,-2.48236 -0.24156,-10.536496 0.003,-12.975982 1.12233,-11.203007 4.06279,-20.780917 9.1843,-29.9160563 l 1.53618,-2.74015 h 5.47631 5.47631 l -0.49924,0.68484 c -2.41341,3.310656 -5.29765,8.4418153 -7.00382,12.4600833 -6.83569,16.098892 -7.07266,34.022086 -0.66592,50.365278 1.74301,4.446298 4.74992,9.997815 7.52608,13.895014 0.41656,0.58477 0.72226,1.12003 0.67935,1.18946 -0.0429,0.0694 -2.43321,0.12626 -5.31175,0.12626 h -5.23371 z"/>
        <path style="fill:#1a1f2e;stroke-width:0.144177" d="M 121.65153,67.017498 V 52.888101 l 3.13587,5.7e-4 3.13586,5.8e-4 3.17191,3.780699 c 1.74455,2.079391 3.89837,4.64314 4.78628,5.697244 l 1.61436,1.916538 4.77081,-5.697761 4.77081,-5.69787 h 3.16659 3.16657 v 14.129397 14.129405 h -3.09878 -3.09876 l -0.0371,-9.382769 -0.037,-9.382768 -4.75785,5.697085 c -2.61683,3.1334 -4.7903,5.700884 -4.82996,5.705506 -0.0397,0.0042 -2.24556,-2.565511 -4.90203,-5.711405 l -4.82995,-5.719804 -0.037,9.397077 -0.0371,9.397078 h -3.02668 -3.02669 z"/>
        <path style="fill:#1a1f2e;stroke-width:0.144177" d="m 100.45743,75.865912 v -5.280979 l -1.344169,-1.819764 c -0.739298,-1.000858 -3.6589,-4.950452 -6.487984,-8.776859 -2.829095,-3.826422 -5.143811,-6.989316 -5.143811,-7.028665 0,-0.03936 1.617879,-0.07154 3.595271,-0.07154 h 3.595282 l 4.42039,5.550836 c 2.431221,3.05296 4.432961,5.550842 4.448301,5.550842 0.0153,0 2.00418,-2.497006 4.41964,-5.54889 l 4.39174,-5.548884 3.64048,-0.0021 c 2.00227,-0.001 3.64048,0.03218 3.64048,0.07376 0,0.04168 -1.83591,2.555739 -4.0798,5.586882 -2.24389,3.031139 -5.16348,6.979234 -6.48798,8.773567 l -2.40819,3.262401 v 5.280114 5.2801 h -3.09983 -3.09982 z"/>
        <path style="fill:#1a1f2e;stroke-width:0.144177" d="m 62.502123,80.992853 c -1.603358,-0.38525 -3.146168,-1.67929 -3.90041,-3.2715 l -0.460373,-0.97187 v -9.731985 -9.731983 l 0.47064,-0.962093 c 0.817123,-1.670376 2.149173,-2.774973 3.881596,-3.2188 0.768181,-0.196799 2.098574,-0.22127 10.08887,-0.185561 9.200985,0.04115 9.204277,0.04126 10.016894,0.369845 1.187347,0.480148 2.594836,1.823046 3.180052,3.034115 0.444291,0.91942 0.467685,1.054456 0.522915,3.017034 l 0.05783,2.05453 h -3.115852 -3.115852 v -1.153422 -1.153422 h -8.003075 -8.003064 l 0.03725,7.965804 0.03725,7.965814 7.965804,0.03725 7.965804,0.03725 v -2.163882 -2.163893 h -3.027719 -3.02773 v -3.02772 -3.02773 h 6.134855 6.134866 l -0.04337,6.019414 -0.04337,6.019405 -0.463865,0.94788 c -0.594481,1.21481 -1.698782,2.31911 -2.913576,2.91359 l -0.947886,0.46386 -9.443633,0.0241 c -5.211651,0.0133 -9.686177,-0.0342 -9.984879,-0.106 z"/>
        <path style="fill:#1a6ec0;fill-opacity:1;stroke-width:0.144177" d="m 25.519705,81.021453 c -0.0439,-0.071 0.03978,-0.28263 0.185983,-0.47036 1.311927,-1.68534 3.639855,-5.502462 5.220114,-8.559464 C 37.220777,59.814061 39.557125,45.873306 37.606851,32.126537 36.200366,22.212685 32.499604,12.59703 26.939043,4.4084047 l -1.3462,-1.982437 5.436392,0.0021 5.436382,0.0021 1.40982,2.557101 c 2.522363,4.575035 4.243812,8.5214633 5.769337,13.2262383 6.107588,18.835993 4.615545,39.223717 -4.167783,56.950123 -0.589373,1.189457 -1.607315,3.006103 -2.262092,4.036963 l -1.190513,1.87431 -5.212463,0.0379 c -2.957294,0.0214 -5.24697,-0.0179 -5.292218,-0.0912 z"/>
      </g>
    </svg>
  </div>
  <div id="report-title">%%REPORT_TITLE%%</div>
</div>
<div id="helper"><p>This is the draft exercise report. All text below can be edited directly in the browser before finalising.</p><p>When ready, click <a href="javascript:if(window.print)window.print()">here</a> or press Ctrl+P and select "Print to PDF". This helper box will not appear in print.</p></div>
<div id="content" contenteditable="true">`;

    const REPORT_FOOTER = `</div></body></html>`;

    /* =============================================
       PRESENTATION WINDOW HTML
       ============================================= */
    const PRESENTATION_HTML = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="google" content="notranslate">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <title>TTX Gym — Participant Window</title>
  <style>
  *{box-sizing:border-box;margin:0;padding:0}
  :root{--back:#141820;--mid:#1e2535;--accent:#2e7de0;--green:#3ec9c8;--text:#e8ecf2;--text2:rgba(232,236,242,0.55)}
  body{font-family:"Montserrat",sans-serif;background:var(--back);background-image:radial-gradient(circle at 82% 60%,rgba(59,59,59,.06) 0,rgba(59,59,59,.06) 69%,transparent 69%),linear-gradient(135deg,#141c33 0%,#0d2040 100%);height:100vh;width:100vw;display:flex;align-items:center;justify-content:center;color:var(--text)}
  ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:rgba(46,125,224,.4);border-radius:99px}
  #pause{position:absolute;inset:0;z-index:9;display:flex;align-items:center;justify-content:center;background:rgba(20,24,32,.85);backdrop-filter:blur(6px)}
  #pause.hidden-overlay{display:none}
  .overlay-card{background:var(--mid);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:2.5rem 3rem;display:flex;flex-direction:column;align-items:center;gap:.75rem;text-align:center}
  .overlay-card svg{fill:rgba(232,236,242,.4);width:40px;height:40px}
  .overlay-card h2{font-size:18px;font-weight:700}
  .container{background:var(--mid);border:1px solid rgba(255,255,255,.07);border-radius:12px;width:84%;height:84%;padding:0 2rem 1.5rem;display:grid;grid-template-rows:auto 1fr auto;gap:0;overflow:hidden;font-size:inherit}
  h1{text-align:center;font-size:1.7em;font-weight:800;color:rgba(232,236,242,.9);padding:1.5rem 0 .75rem;border-bottom:1px solid rgba(255,255,255,.07)}
  #middleWrap{overflow-y:auto;padding:.5rem 0}
  #content{padding:.75rem 0;line-height:1.8;color:var(--text2);font-size:1em}
  #content p{margin-bottom:.75rem}
  #content strong{color:var(--text)}
  blockquote{padding:1rem 1.25rem;margin:1rem 0;background:rgba(30,75,86,.5);border-left:3px solid var(--green);border-radius:0 4px 4px 0}
  .SFmedia{display:block;margin:1em auto;max-width:min(100%,32em);height:auto;border-radius:6px;object-fit:contain}
  #discussionWrap{margin:.75rem 0 0;padding:.75rem 1rem;background:rgba(0,51,102,.3);border-left:3px solid var(--accent);border-radius:0 4px 4px 0;display:none;gap:.75rem;align-items:flex-start}
  #discussionWrap.show{display:flex}
  #discussionWrap svg{fill:var(--accent);width:18px;height:18px;flex-shrink:0;margin-top:2px}
  #discussion{font-style:italic;font-size:13px;color:var(--text2);padding-left:1rem}
  #discussion li{margin-bottom:.4rem}
  #control{display:flex;justify-content:flex-end;align-items:center;gap:1rem;padding-top:.75rem;border-top:1px solid rgba(255,255,255,.07)}
  input[type=range]{accent-color:var(--accent);cursor:pointer}
  #fullscreen{cursor:pointer;fill:rgba(232,236,242,.5);transition:fill .15s}
  #fullscreen:hover{fill:var(--accent)}
  li{padding-bottom:6px}
  .outer{display:flex;justify-content:center;margin:1em 0}
  .chart-container{display:flex;flex-direction:column;gap:.75em;padding:.5em;min-width:16em}
  .bchart{display:flex;align-items:flex-end;gap:.35em;justify-content:center;height:9em}
  .bar{display:flex;flex-direction:column;justify-content:flex-end;min-width:3em;width:4em;height:9em;text-align:center;flex-shrink:0}
  .bar-inner{border-radius:4px 4px 0 0;display:flex;align-items:center;justify-content:center;min-height:0.25em}
  .bar-label{font-size:0.65em;font-weight:700;color:#fff}
  .x-axis-label{margin-top:3px;font-size:0.65em;color:rgba(232,236,242,.5);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:4em}
  .dchart{display:flex;height:1.4em;border-radius:4px;overflow:hidden;margin:.25em 0;min-height:1.4em}
  .segment{display:flex;align-items:center;justify-content:center;color:#fff;font-size:0.65em;font-weight:600}
  .chart-title{display:flex;justify-content:space-evenly;margin-top:.25em}
  .chart-title div{flex:1;text-align:center;font-size:0.7em;color:rgba(232,236,242,.5)}
  .outer h3{margin:0;font-size:0.7em;color:rgba(232,236,242,.5)}
  </style>
</head>
<body>
<div id="pause" class="hidden-overlay">
  <div class="overlay-card">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M360-320h80v-320h-80v320Zm160 0h80v-320h-80v320ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>
    <h2>Exercise Paused</h2>
  </div>
</div>
<div class="container">
  <div><h1 id="title"></h1></div>
  <div id="middleWrap">
    <div id="middle">
      <div id="content"></div>
      <div id="discussionWrap">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M240-400h320v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg>
        <ol id="discussion"></ol>
      </div>
    </div>
  </div>
  <div id="control">
    <svg xmlns="http://www.w3.org/2000/svg" height="1.5rem" viewBox="0 -960 960 960" width="1.5rem" style="fill:rgba(232,236,242,.4)"><path d="M240-80 80-240l160-160 57 56-64 64h494l-63-64 56-56 160 160L720-80l-57-56 64-64H233l63 64-56 56Zm36-360 164-440h80l164 440h-76l-38-112H392l-40 112h-76Zm138-176h132l-64-182h-4l-64 182Z"/></svg>
    <input id="slider" type="range" min="10" max="40" value="14" oninput="changeSizeBySlider()" aria-label="Font size">
    <div id="fullscreen" onclick="toggleFullscreen()" title="Toggle fullscreen">
      <svg xmlns="http://www.w3.org/2000/svg" height="1.75rem" viewBox="0 -960 960 960" width="1.75rem"><path d="M560-280h200v-200h-80v120H560v80ZM200-480h80v-120h120v-80H200v200Zm-40 320q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm0-80h640v-480H160v480Zm0 0v-480 480Z"/></svg>
    </div>
  </div>
</div>
<script>
var bc=new BroadcastChannel('ttx_gym');
bc.onmessage=function(ev){
  if(!ev.data.type)return;
  if(ev.data.type=="pause"){
    document.getElementById('pause').classList.toggle('hidden-overlay',ev.data.switch===true);
  }else if(ev.data.type=="update"){
    document.getElementById('title').textContent=ev.data.title||'';
    document.getElementById('content').innerHTML=ev.data.content||'';
    var dw=document.getElementById('discussionWrap');
    var dl=document.getElementById('discussion');
    dl.innerHTML='';
    if(ev.data.discussion&&ev.data.discussion.length){
      dw.classList.add('show');
      ev.data.discussion.forEach(function(item){var li=document.createElement('li');li.innerHTML=item;dl.appendChild(li);});
    }else{dw.classList.remove('show');}
  }
};
  var cont=document.body;
function changeSizeBySlider(){
  var val=document.getElementById('slider').value+'px';
  // Apply to container so all content text scales correctly
  var container=document.querySelector('.container');
  if(container){container.style.fontSize=val;}
  cont.style.fontSize=val;
}
function toggleFullscreen(){var d=window.document,el=d.documentElement,req=el.requestFullscreen||el.webkitRequestFullScreen||el.msRequestFullscreen,ex=d.exitFullscreen||d.webkitExitFullscreen||d.msExitFullscreen;if(!d.fullscreenElement&&!d.webkitFullscreenElement&&!d.msFullscreenElement)req.call(el);else ex.call(d);}
<\/script>
</body></html>`;

    /* =============================================
       FINISH SCREEN DATA
       ============================================= */
    const finish = {
      type: "update",
      title: "Exercise Outcomes",
      content: `<p>Finish the exercise by discussing and collating what you learned, how your understanding of this scenario has changed, and what processes you might update as a result.</p>
<p>Make recommendations that will develop confidence in areas identified as having scope for improvement. Allocate recommendations to the people in your organisation who can facilitate change and action improvement.</p>
<p>Discuss the risks associated with not addressing the recommendations. Ensure any recommendations are implemented and, when ready, run the exercise again to see how those changes have impacted your organisation.</p>`,
      discussion: [
        "What did you learn from running the exercise?",
        "How has your understanding of this scenario changed?",
        "What will you look to change or implement across your organisation?",
        "How can recommendations be assigned and tracked within your organisation?"
      ]
    };

    /* =============================================
       STATE
       ============================================= */
    let start;
    let firsttimer = 0;
    let timerInterval = null;
    let currentTimerLabel = '';
    let stageTime = [];
    let questionCounter = 0;
    let roundCounter = 0;
    let ActiveStage = 0;
    let fileName, fileContent, data;
    let timer = false;
    let exerciseComplete = false;
    let qList = [];
    let rawFileData = '';
    let bc = new BroadcastChannel('ttx_gym');
    let saveTimeout = null;
    let sessionKey = '';

    let progressDiv = document.createElement('div');
    let reportDiv = document.createElement('div');
    let overallScore = '';
    const AUTOSAVE_DELAY = 1200; // ms

    /* =============================================
       INIT
       ============================================= */
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    document.getElementById('questionsContainer').addEventListener('change', () => { updateProgress(); scheduleSave(); });

    // URL param load
    const urlParams = new URLSearchParams(window.location.search);
    const preview = localStorage.getItem('preview');
    if (preview) {
      localStorage.removeItem('preview');
      try {
        fileContent = parseConfigToJSON(preview);
        populateScenario();
      } catch (err) { showParseError('Error decoding preview data.'); }
    }
    if (urlParams.has('q')) {
      const targetFile = urlParams.get('q').replace(/\W/g, '');
      fileName = targetFile + '.ttxf';
      fetch('../lib/scenarios/' + targetFile + '.ttxf')
        .then(r => { if (!r.ok) throw new Error(r.statusText); return r.text(); })
        .then(d => { rawFileData = d; fileContent = parseConfigToJSON(d); populateScenario(); })
        .catch(e => showParseError('Could not load scenario file: ' + e.message));
    }

    /* =============================================
       AUTOSAVE
       ============================================= */
    function scheduleSave() {
      const indicator = document.getElementById('save-indicator');
      indicator.classList.remove('saved');
      indicator.querySelector('span').textContent = 'Saving…';
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        if (sessionKey) {
          try {
            const saveData = gatherSessionData();
            localStorage.setItem('ttxgym_autosave_' + sessionKey, JSON.stringify(saveData));
            indicator.classList.add('saved');
            indicator.querySelector('span').textContent = 'Saved';
          } catch (e) {
            indicator.querySelector('span').textContent = 'Save failed';
          }
        }
      }, AUTOSAVE_DELAY);
    }

    function gatherSessionData() {
      const notes = {};
      document.querySelectorAll('textarea.description').forEach((ta, i) => {
        notes['stage_' + i] = ta.value;
      });
      const answers = {};
      document.querySelectorAll('#questionsContainer input[type="radio"]:checked').forEach(r => {
        answers[r.name] = r.value;
      });
      return { notes, answers, stageTime: [...stageTime], timestamp: Date.now() };
    }

    function restoreSession(saveData) {
      if (!saveData) return;
      try {
        const d = JSON.parse(saveData);
        if (d.stageTime) stageTime = d.stageTime;
        if (d.notes) {
          document.querySelectorAll('textarea.description').forEach((ta, i) => {
            if (d.notes['stage_' + i]) ta.value = d.notes['stage_' + i];
          });
        }
        if (d.answers) {
          const container = document.getElementById('questionsContainer');
          Object.entries(d.answers).forEach(([name, val]) => {
            const el = container.querySelector(`input[name="${name}"][value="${val}"]`);
            if (el) el.checked = true;
          });
        }
        if (d.stageTime) {
          d.stageTime.forEach((t, i) => {
            const el = document.getElementById('time' + i);
            if (el) el.innerHTML = formatTime(Number(t));
          });
        }
        // Reapply complete markers based on restored answers
        updateProgress();
      } catch (e) { /* ignore restore errors */ }
    }

    /* =============================================
       RESET & CLEAR
       ============================================= */
    function confirmResetScenario() {
      if (!roundCounter) return; // no scenario loaded
      if (!confirm('Reset the scenario? This will clear all notes, answers and timing data. The scenario file will remain loaded.')) return;
      // Stop timer
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      firsttimer = 0;
      timer = false;
      // Clear notes
      document.querySelectorAll('textarea.description').forEach(ta => ta.value = '');
      // Clear all radio answers and re-enable all inputs (setActiveStage disabled them)
      document.querySelectorAll('#questionsContainer input[type="radio"]').forEach(r => { r.checked = false; r.disabled = false; });
      document.querySelectorAll('#questionsContainer textarea').forEach(ta => { ta.disabled = false; });
      // Clear all quiz feedback
      document.querySelectorAll('.quiz-feedback').forEach(f => { f.textContent = ''; f.className = 'quiz-feedback'; });
      // Reset stage timers — reset each time element by known id, never target the #times container itself
      stageTime = new Array(roundCounter + 2).fill(0);
      for (let i = 1; i <= roundCounter; i++) {
        const el = document.getElementById('time' + i);
        if (el) el.textContent = '00:00';
      }
      // Remove complete markers
      document.querySelectorAll('.stage.complete, .round.complete').forEach(el => el.classList.remove('complete'));
      // Close summary overlay
      const overlay = document.getElementById('summary-overlay');
      if (overlay) overlay.classList.add('hidden-overlay');
      // Clear localStorage
      if (sessionKey) localStorage.removeItem('ttxgym_autosave_' + sessionKey);
      exerciseComplete = false;
      ActiveStage = 0;
      // Return to intro stage
      setActiveStage(0);
      const scribeInner = document.getElementById('scribe-inner');
      if (scribeInner) scribeInner.scrollTop = 0;
      setTimerLabel('ready');
      updateProgress();
      bc.postMessage(start);
      const ind = document.getElementById('save-indicator');
      ind.querySelector('span').textContent = 'Reset';
    }

    function clearAllAnswers() {
      document.querySelectorAll('#questionsContainer input[type="radio"]').forEach(r => r.checked = false);
      document.querySelectorAll('.quiz-feedback').forEach(f => { f.textContent = ''; f.className = 'quiz-feedback'; });
      document.querySelectorAll('.stage.complete, .round.complete').forEach(el => el.classList.remove('complete'));
      const overlay = document.getElementById('summary-overlay');
      if (overlay) overlay.classList.add('hidden-overlay');
      exerciseComplete = false;
      updateProgress();
      scheduleSave();
    }

    /* =============================================
       FILE HANDLING
       ============================================= */
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      resetExercise();
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          fileName = file.name;
          rawFileData = e.target.result;
          fileContent = parseConfigToJSON(e.target.result);
          populateScenario();
          // Attempt to restore saved session
          sessionKey = btoa(fileName).replace(/[^a-z0-9]/gi, '').substring(0, 20);
          const saved = localStorage.getItem('ttxgym_autosave_' + sessionKey);
          if (saved) {
            setTimeout(() => restoreSession(saved), 50);
          }
        } catch (err) {
          showParseError('Error parsing scenario file. Please check the format.');
          console.error(err);
        }
      };
      reader.readAsText(file);
    }

    function showParseError(msg) {
      const el = document.getElementById('parse-error');
      el.textContent = msg;
      el.classList.add('visible');
    }

    /* =============================================
       SCENARIO POPULATION
       ============================================= */
    function populateScenario() {
      document.getElementById('parse-error').classList.remove('visible');

      if (!fileContent || !fileContent.stages) {
        showParseError('Scenario file is missing required content.');
        return;
      }

      roundCounter = 0;
      questionCounter = 0;
      qList = [];

      start = {
        type: "update",
        title: fileContent.title || 'Exercise',
        content: fileContent.summary || '',
        discussion: fileContent.topics
      };

      if (fileContent.conclusion) finish.content = fileContent.conclusion;

      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';
      const stageContainer = document.getElementById('stageWrapper');
      stageContainer.innerHTML = '';
      document.getElementById('times').innerHTML = '';

      // Previous button
      const prevBtn = document.createElement('div');
      prevBtn.id = 'previous';
      prevBtn.className = 'link hidden';
      prevBtn.setAttribute('role', 'button');
      prevBtn.setAttribute('tabindex', '0');
      prevBtn.setAttribute('aria-label', 'Previous stage');
      prevBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z"/></svg><span>Prev</span>`;
      prevBtn.onclick = previousStage;
      prevBtn.onkeydown = (e) => { if (e.key === 'Enter') previousStage(); };
      stageContainer.appendChild(prevBtn);

      // Start marker
      const startMarker = document.createElement('div');
      startMarker.id = 'marker0';
      startMarker.className = 'stage';
      startMarker.setAttribute('aria-label', 'Start');
      startMarker.setAttribute('role', 'button');
      startMarker.setAttribute('tabindex', '0');
      startMarker.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="m380-300 280-180-280-180v360ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg>`;
      startMarker.onclick = () => goToStage(0);
      startMarker.onkeydown = (e) => { if (e.key === 'Enter') goToStage(0); };
      stageContainer.appendChild(startMarker);
      stageContainer.appendChild(makeConnector());

      data = fileContent.stages;

      // Intro card (stage 0)
      const introCard = buildStaticCard(
        'round0', 'Intro',
        fileContent.title || 'Exercise Introduction',
        fileContent.summary || '',
        fileContent.topics || []
      );
      container.appendChild(introCard);

      if (Array.isArray(data)) {
        data.forEach((round, idx) => {
          roundCounter++;
          const roundDiv = buildRoundCard(round, roundCounter);
          container.appendChild(roundDiv);

          // Timing row
          buildTimingRow(roundCounter, round.stage);

          // Stage marker — capture stageNum by value to avoid closure bug
          const stageNum = roundCounter;
          const marker = document.createElement('div');
          marker.innerHTML = stageNum;
          marker.className = 'stage';
          marker.id = 'marker' + stageNum;
          marker.setAttribute('aria-label', `Stage ${stageNum}: ${round.stage}`);
          marker.setAttribute('role', 'button');
          marker.setAttribute('tabindex', '0');
          marker.onclick = () => goToStage(stageNum);
          marker.onkeydown = (e) => { if (e.key === 'Enter') goToStage(stageNum); };
          stageContainer.appendChild(marker);
          stageContainer.appendChild(makeConnector());

          stageTime[roundCounter] = 0;
        });
      }

      // Outro card (finish stage)
      const outroCard = buildStaticCard(
        'round-finish', 'Finish',
        finish.title || 'Exercise Outcomes',
        finish.content,
        finish.discussion || []
      );
      container.appendChild(outroCard);

      // Attach collapsible listeners
      document.querySelectorAll('.sc_collapsible').forEach(collapsible => {
        collapsible.querySelector('.sc_title-bar').addEventListener('click', () => {
          toggleCollapsible(collapsible.id);
        });
      });

      // Sidebar info
      const confirmer = document.getElementById('scenario-loader-data');
      confirmer.innerHTML = '';
      const fileInfo = document.createElement('div');
      fileInfo.id = 'file-name';
      fileInfo.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h440l200 200v440q0 33-23.5 56.5T760-120H200Zm0-80h560v-400H600v-160H200v560Zm80-80h400v-80H280v80Zm0-320h200v-80H280v80Zm0 160h400v-80H280v80Zm-80-320v160-160 560-560Z"/></svg><span>${fileName}</span>`;

      const stagesStat = document.createElement('div');
      stagesStat.className = 'stat';
      stagesStat.textContent = `${roundCounter} Stage${roundCounter !== 1 ? 's' : ''}`;

      const qStat = document.createElement('div');
      qStat.className = 'stat';
      qStat.textContent = `${questionCounter} Question${questionCounter !== 1 ? 's' : ''}`;

      confirmer.appendChild(fileInfo);
      confirmer.appendChild(stagesStat);
      confirmer.appendChild(qStat);

      // Title bar
      document.getElementById('title-text').innerHTML = `<strong>${escapeHTML(fileContent.title || '')}</strong>`;

      // Show UI — exclude hamburger which is controlled by CSS media query
      document.querySelectorAll('.hide').forEach(el => {
        if (el.id !== 'hamburger') el.classList.remove('hide');
      });
      document.getElementById('welcome-screen').style.display = 'none';

      // Finish marker
      const finishMarker = document.createElement('div');
      finishMarker.className = 'stage';
      finishMarker.id = 'marker' + (roundCounter + 1);
      finishMarker.setAttribute('aria-label', 'Finish');
      finishMarker.setAttribute('role', 'button');
      finishMarker.setAttribute('tabindex', '0');
      finishMarker.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q65 0 123 19t107 53l-58 59q-38-24-81-37.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160q133 0 226.5-93.5T800-480q0-18-2-36t-6-35l65-65q11 32 17 66t6 70q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm-56-216L254-466l56-56 114 114 400-401 56 56-456 457Z"/></svg>`;
      finishMarker.onclick = () => goToStage(roundCounter + 1);
      finishMarker.onkeydown = (e) => { if (e.key === 'Enter') goToStage(roundCounter + 1); };
      stageContainer.appendChild(finishMarker);

      // Next button
      const nextBtn = document.createElement('div');
      nextBtn.id = 'next';
      nextBtn.className = 'link';
      nextBtn.setAttribute('role', 'button');
      nextBtn.setAttribute('tabindex', '0');
      nextBtn.setAttribute('aria-label', 'Next stage');
      nextBtn.innerHTML = `<span>Next</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="m321-80-71-71 329-329-329-329 71-71 400 400L321-80Z"/></svg>`;
      nextBtn.onclick = nextStage;
      nextBtn.onkeydown = (e) => { if (e.key === 'Enter') nextStage(); };
      stageContainer.appendChild(nextBtn);

      // Start at the intro stage
      ActiveStage = 0;
      setActiveStage(0);
      bc.postMessage(start);
    }

    function makeConnector() {
      const c = document.createElement('div');
      c.className = 'connector';
      return c;
    }

    function buildStaticCard(id, badgeText, titleText, content, discussion) {
      const roundDiv = document.createElement('div');
      roundDiv.classList.add('round', 'sc_collapsible');
      roundDiv.id = id;
      roundDiv.setAttribute('role', 'listitem');

      const titleBar = document.createElement('div');
      titleBar.classList.add('sc_title-bar');
      titleBar.setAttribute('role', 'button');
      titleBar.setAttribute('tabindex', '0');
      titleBar.setAttribute('aria-expanded', 'false');
      titleBar.setAttribute('aria-controls', id + '-content');

      const titleLeft = document.createElement('div');
      titleLeft.className = 'sc_title-left';

      const badge = document.createElement('span');
      badge.className = 'stage-badge';
      badge.textContent = badgeText;

      const titleSpan = document.createElement('span');
      titleSpan.classList.add('sc_title');
      titleSpan.textContent = titleText;

      titleLeft.appendChild(badge);
      titleLeft.appendChild(titleSpan);

      const toggleBtn = document.createElement('button');
      toggleBtn.classList.add('sc_toggle-btn');
      toggleBtn.textContent = '▼';
      toggleBtn.setAttribute('aria-label', `Toggle ${titleText}`);
      toggleBtn.setAttribute('tabindex', '-1');
      toggleBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCollapsible(id); });

      titleBar.appendChild(titleLeft);
      titleBar.appendChild(toggleBtn);
      titleBar.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCollapsible(id); }
      });
      roundDiv.appendChild(titleBar);

      const wrapper = document.createElement('div');
      wrapper.classList.add('sc_content-wrapper');
      wrapper.id = id + '-content';

      if (content) {
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('sc_content');
        contentDiv.innerHTML = content;
        wrapper.appendChild(contentDiv);
      }

      if (discussion && discussion.length) {
        const talkDiv = document.createElement('div');
        talkDiv.className = 'talk';
        talkDiv.innerHTML = `<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="M240-400h320v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg></div>`;
        const talkContent = document.createElement('div');
        const talkList = document.createElement('ul');
        discussion.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = item;
          talkList.appendChild(li);
        });
        talkContent.appendChild(talkList);
        talkDiv.appendChild(talkContent);
        wrapper.appendChild(talkDiv);
      }

      roundDiv.appendChild(wrapper);
      return roundDiv;
    }

    function buildRoundCard(round, num) {
      const roundDiv = document.createElement('div');
      roundDiv.classList.add('round', 'sc_collapsible');
      roundDiv.setAttribute('data-section', round.stage);
      roundDiv.id = 'round' + num;
      roundDiv.setAttribute('role', 'listitem');

      // Title bar
      const titleBar = document.createElement('div');
      titleBar.classList.add('sc_title-bar');
      titleBar.setAttribute('role', 'button');
      titleBar.setAttribute('tabindex', '0');
      titleBar.setAttribute('aria-expanded', 'false');
      titleBar.setAttribute('aria-controls', 'content' + num);

      const titleLeft = document.createElement('div');
      titleLeft.className = 'sc_title-left';

      const badge = document.createElement('span');
      badge.className = 'stage-badge';
      badge.textContent = `Stage ${num}`;
      badge.setAttribute('aria-hidden', 'true');

      const titleSpan = document.createElement('span');
      titleSpan.classList.add('sc_title');
      titleSpan.textContent = round.stage;

      titleLeft.appendChild(badge);
      titleLeft.appendChild(titleSpan);

      const toggleBtn = document.createElement('button');
      toggleBtn.classList.add('sc_toggle-btn');
      toggleBtn.textContent = '▼';
      toggleBtn.setAttribute('aria-label', `Toggle stage ${num}`);
      toggleBtn.setAttribute('tabindex', '-1'); // handled by titleBar
      toggleBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleCollapsible(roundDiv.id); });

      titleBar.appendChild(titleLeft);
      titleBar.appendChild(toggleBtn);
      titleBar.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCollapsible(roundDiv.id); }
      });
      roundDiv.appendChild(titleBar);

      // Content wrapper
      const wrapper = document.createElement('div');
      wrapper.classList.add('sc_content-wrapper');
      wrapper.id = 'content' + num;

      // Main content
      if (round.content) {
        const content = document.createElement('div');
        content.classList.add('sc_content');
        content.innerHTML = round.content;
        wrapper.appendChild(content);
      }

      // Discussion points
      if (round.discussion && round.discussion.length) {
        const talkDiv = document.createElement('div');
        talkDiv.className = 'talk';
        talkDiv.innerHTML = `<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="M240-400h320v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg></div>`;
        const talkContent = document.createElement('div');
        const talkList = document.createElement('ul');
        talkList.setAttribute('aria-label', 'Discussion points');
        round.discussion.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = item;
          talkList.appendChild(li);
        });
        talkContent.appendChild(talkList);
        talkDiv.appendChild(talkContent);
        wrapper.appendChild(talkDiv);
      }

      // Prompts
      if (round.prompts && round.prompts.length) {
        const promptDiv = document.createElement('div');
        promptDiv.className = 'prompt';
        promptDiv.innerHTML = `<div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="M480-360q17 0 28.5-11.5T520-400q0-17-11.5-28.5T480-440q-17 0-28.5 11.5T440-400q0 17 11.5 28.5T480-360Zm-40-160h80v-240h-80v240ZM80-80v-720q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v480q0 33-23.5 56.5T800-240H240L80-80Zm126-240h594v-480H160v525l46-45Zm-46 0v-480 480Z"/></svg></div>`;
        const promptContent = document.createElement('div');
        const promptList = document.createElement('ul');
        promptList.setAttribute('aria-label', 'Facilitator prompts');
        round.prompts.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = item;
          promptList.appendChild(li);
        });
        promptContent.appendChild(promptList);
        promptDiv.appendChild(promptContent);
        wrapper.appendChild(promptDiv);
      }

      // Notes textarea
      const notesArea = document.createElement('div');
      notesArea.className = 'notes-area';
      const notesLabel = document.createElement('div');
      notesLabel.className = 'notes-label';
      notesLabel.textContent = 'Facilitator Notes';
      const notesId = `notes_${num}`;
      notesLabel.setAttribute('for', notesId);
      const textarea = document.createElement('textarea');
      textarea.className = 'description';
      textarea.id = notesId;
      textarea.placeholder = 'Record observations, key points and actions here…';
      textarea.setAttribute('aria-label', `Facilitator notes for stage ${num}`);
      notesArea.appendChild(notesLabel);
      notesArea.appendChild(textarea);
      wrapper.appendChild(notesArea);

      // Questions
      if (round.questions && round.questions.length) {
        round.questions.forEach(item => {
          wrapper.appendChild(buildQuestion(item, num));
        });
      }

      roundDiv.appendChild(wrapper);
      return roundDiv;
    }

    function buildQuestion(item, stageNum) {
      const isQuiz = !!item.quiz;

      const qDiv = document.createElement('div');
      qDiv.className = 'question' + (isQuiz ? ' question-quiz' : '');

      const badge = document.createElement('div');
      badge.className = 'question-type-badge ' + (isQuiz ? 'quiz' : 'rating');
      badge.textContent = isQuiz ? 'Quiz' : 'Rating';
      qDiv.appendChild(badge);

      const labelId = `qlabel_${questionCounter}`;

      const qLabel = document.createElement('div');
      qLabel.className = 'question-label';
      qLabel.id = labelId;
      qLabel.textContent = item.question;
      qDiv.appendChild(qLabel);

      qList[`question_${questionCounter}`] = item.question;

      const choices = document.createElement('div');
      choices.className = 'choices';
      choices.setAttribute('role', 'radiogroup');
      choices.setAttribute('aria-labelledby', labelId);

      item.answers.forEach((choice, ci) => {
        const choiceWrap = document.createElement('div');
        choiceWrap.className = 'choice';

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = `question_${questionCounter}`;
        input.value = choice;
        input.id = `q${questionCounter}_c${ci}`;
        if (isQuiz) input.setAttribute('data-quiz', item.quiz);

        const label = document.createElement('label');
        label.htmlFor = input.id;
        label.textContent = choice;

        // Instant quiz feedback on selection
        if (isQuiz) {
          input.addEventListener('change', () => {
            const feedback = qDiv.querySelector('.quiz-feedback');
            if (input.checked) {
              const correct = input.value === item.quiz;
              feedback.textContent = correct ? '✓ Correct!' : `✗ Incorrect — correct answer: "${item.quiz}"`;
              feedback.className = 'quiz-feedback ' + (correct ? 'correct' : 'incorrect');
            }
          });
        }

        choiceWrap.appendChild(input);
        choiceWrap.appendChild(label);
        choices.appendChild(choiceWrap);
      });

      qDiv.appendChild(choices);

      if (isQuiz) {
        const feedback = document.createElement('div');
        feedback.className = 'quiz-feedback';
        qDiv.appendChild(feedback);
      }

      questionCounter++;
      return qDiv;
    }

    function buildTimingRow(num, stageName) {
      const timingdiv = document.getElementById('times');
      const row = document.createElement('div');
      row.className = 'data-row';
      row.setAttribute('role', 'listitem');

      const label = document.createElement('div');
      label.className = 'data-label';
      label.textContent = `Stage ${num}`;
      label.setAttribute('title', stageName);

      const num_el = document.createElement('div');
      num_el.className = 'data-number';
      num_el.id = 'time' + num;
      num_el.textContent = '00:00';
      num_el.setAttribute('aria-label', `Stage ${num} duration`);
      num_el.setAttribute('aria-live', 'polite');

      row.appendChild(label);
      row.appendChild(num_el);
      timingdiv.appendChild(row);
    }

    /* =============================================
       NAVIGATION
       ============================================= */
    function setActiveStage(stageNumber) {
      // Update stage markers
      document.querySelectorAll('.stage').forEach((stage, index) => {
        stage.classList.toggle('active', index === stageNumber);
      });

      // Collapse all round cards including intro/outro
      collapseCollapsible('round0');
      collapseCollapsible('round-finish');
      document.querySelectorAll('.round[id^="round"]').forEach((stage) => {
        const idNum = parseInt(stage.id.replace('round', ''), 10);
        if (!isNaN(idNum) && idNum > 0) {
          collapseCollapsible('round' + idNum);
          stage.classList.toggle('active', idNum === stageNumber);
        }
      });
      // Active state for intro/outro
      const introCard = document.getElementById('round0');
      if (introCard) introCard.classList.toggle('active', stageNumber === 0);
      const outroCard = document.getElementById('round-finish');
      if (outroCard) outroCard.classList.toggle('active', stageNumber === roundCounter + 1);

      if (stageNumber === 0) {
        expandCollapsible('round0');
        setTimerLabel('ready');
      } else if (stageNumber > 0 && stageNumber < roundCounter + 1) {
        expandCollapsible('round' + stageNumber);
        setTimerLabel('pause');
      } else if (stageNumber === roundCounter + 1) {
        expandCollapsible('round-finish');
        setTimerLabel('ready');
        if (exerciseComplete) {
          const m = document.getElementById('marker' + stageNumber);
          if (m) m.classList.add('complete');
        }
      }

      // Previous button
      const prevBtn = document.getElementById('previous');
      if (prevBtn) prevBtn.classList.toggle('hidden', stageNumber === 0);

      // Next / Show Summary button
      const nextBtn = document.getElementById('next');
      if (nextBtn) {
        if (stageNumber === roundCounter + 1) {
          // Finish stage — replace Next with Show Summary
          nextBtn.classList.remove('hidden');
          nextBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="M80-600v-160q0-33 23.5-56.5T160-840h640q33 0 56.5 23.5T880-760v160h-80v-160H160v160H80Zm80 360q-33 0-56.5-23.5T80-320v-200h80v200h640v-200h80v200q0 33-23.5 56.5T800-240H160ZM40-120v-80h880v80H40Zm440-420ZM80-520v-80h240q11 0 21 6t15 16l47 93 123-215q5-9 14-14.5t20-5.5q11 0 21 5.5t15 16.5l49 98h235v80H620q-11 0-21-5.5T584-542l-26-53-123 215q-5 10-15 15t-21 5q-11 0-20.5-6T364-382l-69-138H80Z"/></svg><span>Show Summary</span>`;
          nextBtn.onclick = handleFormSubmit;
          nextBtn.onkeydown = (e) => { if (e.key === 'Enter') handleFormSubmit(); };
        } else {
          // All other stages — normal Next behaviour, hidden only beyond finish
          nextBtn.classList.toggle('hidden', stageNumber > roundCounter + 1);
          nextBtn.innerHTML = `<span>Next</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="m321-80-71-71 329-329-329-329 71-71 400 400L321-80Z"/></svg>`;
          nextBtn.onclick = nextStage;
          nextBtn.onkeydown = (e) => { if (e.key === 'Enter') nextStage(); };
        }
      }

      // Enable/disable inputs — only numbered round cards have inputs
      document.querySelectorAll('.round[id^="round"]').forEach((section) => {
        const idNum = parseInt(section.id.replace('round', ''), 10);
        if (!isNaN(idNum) && idNum > 0) {
          const disabled = idNum !== stageNumber;
          section.querySelectorAll('input[type="radio"]').forEach(el => el.disabled = disabled);
          section.querySelectorAll('textarea').forEach(el => el.disabled = disabled);
        }
      });

      // Update hamburger aria-expanded
      const hamburger = document.getElementById('hamburger');
      if (hamburger) hamburger.setAttribute('aria-expanded', !document.getElementById('controller').classList.contains('hidden'));
    }

    function setTimerLabel(state) {
      const timerEl = document.getElementById('timer');
      if (!timerEl) return;
      if (state === 'ready') {
        currentTimerLabel = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="M320-320h80v-320h-80v320Zm160 0 240-160-240-160v320Zm0 240q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg><span class="indent">Timer Ready</span>`;
      } else if (state === 'pause') {
        currentTimerLabel = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="M360-320h80v-320h-80v320Zm160 0h80v-320h-80v320ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg><span class="indent">Pause</span>`;
      } else if (state === 'resume') {
        currentTimerLabel = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" aria-hidden="true"><path d="m380-300 280-180-280-180v360ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z"/></svg><span class="indent">Resume</span>`;
      }
      timerEl.innerHTML = currentTimerLabel;
    }

    function nextStage() {
      if (ActiveStage < roundCounter) {
        ActiveStage++;
        if (firsttimer === 0) {
          const m = document.getElementById('marker0');
          if (m) m.classList.add('complete');
          firsttimer = 1;
          toggleTimer();
          startStopTimer();
        }
        setActiveStage(ActiveStage);
        scrollRoundIntoView(ActiveStage);
        bc.postMessage({ type: "update", title: data[ActiveStage - 1].stage, content: data[ActiveStage - 1].content, discussion: data[ActiveStage - 1].discussion });
      } else {
        ActiveStage = roundCounter + 1;
        setActiveStage(ActiveStage);
        bc.postMessage(finish);
      }
    }

    function previousStage() {
      if (ActiveStage > 1) {
        ActiveStage--;
        setActiveStage(ActiveStage);
        scrollRoundIntoView(ActiveStage);
        bc.postMessage({ type: "update", title: data[ActiveStage - 1].stage, content: data[ActiveStage - 1].content, discussion: data[ActiveStage - 1].discussion });
      } else {
        ActiveStage = 0;
        setActiveStage(ActiveStage);
        bc.postMessage(start);
      }
    }

    function goToStage(stage) {
      ActiveStage = stage;
      if (stage > 0 && stage <= roundCounter) {
        if (firsttimer === 0) {
          const m = document.getElementById('marker0');
          if (m) m.classList.add('complete');
          firsttimer = 1; toggleTimer(); startStopTimer();
        }
        setActiveStage(ActiveStage);
        scrollRoundIntoView(ActiveStage);
        bc.postMessage({ type: "update", title: data[ActiveStage - 1].stage, content: data[ActiveStage - 1].content, discussion: data[ActiveStage - 1].discussion });
      } else if (stage === 0) {
        setActiveStage(ActiveStage);
        bc.postMessage(start);
      } else if (stage === roundCounter + 1) {
        setActiveStage(ActiveStage);
        bc.postMessage(finish);
      }
    }

    // Scroll a round card into view by scrolling #scribe-inner directly,
    // never touching the page/body scroll position
    function scrollRoundIntoView(stageNum) {
      const target = document.getElementById('round' + stageNum);
      const container = document.getElementById('scribe-inner');
      if (!target || !container) return;
      const targetTop = target.offsetTop - container.offsetTop;
      const targetBottom = targetTop + target.offsetHeight;
      const visibleTop = container.scrollTop;
      const visibleBottom = container.scrollTop + container.clientHeight;
      if (targetTop < visibleTop) {
        container.scrollTo({ top: targetTop - 16, behavior: 'smooth' });
      } else if (targetBottom > visibleBottom) {
        container.scrollTo({ top: targetBottom - container.clientHeight + 16, behavior: 'smooth' });
      }
    }

    /* =============================================
       SIDEBAR TOGGLE
       ============================================= */
    function toggleSidebar() {
      const ctrl = document.getElementById('controller');
      const overlay = document.getElementById('sidebar-overlay');
      const hamburger = document.getElementById('hamburger');
      const isMobile = window.innerWidth <= 768;

      if (isMobile) {
        const isOpen = ctrl.classList.contains('show');
        ctrl.classList.toggle('show', !isOpen);
        overlay.classList.toggle('active', !isOpen);
        hamburger.setAttribute('aria-expanded', String(!isOpen));
      } else {
        const isCollapsed = ctrl.classList.contains('collapsed');
        ctrl.classList.toggle('collapsed', !isCollapsed);
        // Also update pause overlay left offset
        const pauseEl = document.getElementById('pause');
        if (pauseEl) {
          pauseEl.style.left = isCollapsed ? 'var(--sidebar-width)' : '0';
        }
        hamburger.setAttribute('aria-expanded', String(isCollapsed));
      }
    }

    function closeSidebar() {
      const ctrl = document.getElementById('controller');
      ctrl.classList.remove('show');
      document.getElementById('sidebar-overlay').classList.remove('active');
      document.getElementById('hamburger').setAttribute('aria-expanded', 'false');
    }

    /* =============================================
       TIMER
       ============================================= */
    const startStopTimer = () => {
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      else { timerInterval = setInterval(toggleClock, 1000); }
    };

    const toggleTimer = () => {
      if (ActiveStage > 0 && ActiveStage < roundCounter + 1) {
        if (firsttimer > 0) {
          if (timer) {
            setTimerLabel('resume');
            document.getElementById('pause').classList.remove('hidden-overlay');
            timer = false;
            bc.postMessage({ type: "pause", switch: timer });
          } else {
            setTimerLabel('pause');
            document.getElementById('pause').classList.add('hidden-overlay');
            timer = true;
            bc.postMessage({ type: "pause", switch: timer });
          }
        }
      }
    };

    const toggleClock = () => {
      if (timer && ActiveStage > 0 && ActiveStage < roundCounter + 1) {
        stageTime[ActiveStage] = (stageTime[ActiveStage] || 0) + 1;
        const el = document.getElementById('time' + ActiveStage);
        if (el) el.textContent = formatTime(stageTime[ActiveStage]);
      }
    };

    const formatTime = (seconds) => {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    };

    /* =============================================
       COLLAPSIBLES
       ============================================= */
    function toggleCollapsible(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const wrapper = el.querySelector('.sc_content-wrapper');
      const isOpen = wrapper.style.height !== '0px' && wrapper.style.height !== '';
      if (isOpen) {
        collapseCollapsible(id);
      } else {
        expandCollapsible(id);
      }
    }

    function expandCollapsible(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const wrapper = el.querySelector('.sc_content-wrapper');
      const btn = el.querySelector('.sc_toggle-btn');
      const titleBar = el.querySelector('.sc_title-bar');
      // Animate to measured height, then switch to 'auto' so content can grow freely
      // (e.g. quiz feedback appearing, summary panel added) without clipping
      wrapper.style.height = wrapper.scrollHeight + 'px';
      btn.textContent = '▲';
      titleBar.setAttribute('aria-expanded', 'true');
      wrapper._expandTimer = setTimeout(() => {
        // Only set auto if it wasn't collapsed again in the meantime
        if (wrapper.style.height !== '0px') wrapper.style.height = 'auto';
      }, 300); // matches transition duration
    }

    function collapseCollapsible(id) {
      const el = document.getElementById(id);
      if (!el) return;
      const wrapper = el.querySelector('.sc_content-wrapper');
      const btn = el.querySelector('.sc_toggle-btn');
      const titleBar = el.querySelector('.sc_title-bar');
      // Cancel any pending auto-height timer
      if (wrapper._expandTimer) { clearTimeout(wrapper._expandTimer); wrapper._expandTimer = null; }
      // Must snap from auto back to a px value first, then animate to 0
      // Otherwise the transition has no start point to animate from
      if (wrapper.style.height === 'auto') {
        wrapper.style.height = wrapper.scrollHeight + 'px';
        // Force reflow so the browser registers the px value before transitioning
        wrapper.getBoundingClientRect();
      }
      wrapper.style.height = '0px';
      btn.textContent = '▼';
      titleBar.setAttribute('aria-expanded', 'false');
    }

    /* =============================================
       PROGRESS / REPORT
       ============================================= */
    function handleFormSubmit() {
      const Scores = updateProgress();
      bc.postMessage({ type: "update", title: overallScore, content: generateCharts(Scores) + progressDiv.innerHTML });

      // Populate summary overlay
      const title = document.getElementById('summary-overlay-title');
      const body = document.getElementById('summary-overlay-body');
      if (title) title.textContent = overallScore;
      if (body) {
        body.innerHTML = '';
        const chartsEl = document.createElement('div');
        chartsEl.innerHTML = generateCharts(Scores);
        body.appendChild(chartsEl);
        body.appendChild(progressDiv.cloneNode(true));
      }

      // Show overlay
      const overlay = document.getElementById('summary-overlay');
      if (overlay) overlay.classList.remove('hidden-overlay');
    }

    function closeSummaryOverlay() {
      const overlay = document.getElementById('summary-overlay');
      if (overlay) overlay.classList.add('hidden-overlay');
    }

    function updateProgress() {
      progressDiv.innerHTML = '';
      reportDiv.innerHTML = '';
      let totalSectionScores = 0, totalSections = 0;
      let SectionScores = [];
      let completion = true;
      let tick = 0;

      document.querySelectorAll('.round[id^="round"]').forEach(section => {
        const idNum = parseInt(section.id.replace('round', ''), 10);
        if (isNaN(idNum) || idNum < 1) return; // skip intro (round0) and outro (round-finish)
        tick++;
        const inputs = section.querySelectorAll('input[type="radio"]');
        const uniqueQuestions = [...new Set(Array.from(inputs).map(i => i.name))];
        let totalScore = 0, answeredQuestions = 0;

        const sectionName = section.getAttribute('data-section');
        const sectionProgress = document.createElement('ul');
        const reportProgress = document.createElement('div');
        const sectionTitle = document.createElement('h3');
        sectionTitle.innerHTML = `Stage ${tick}: "${sectionName}"`;
        reportProgress.appendChild(sectionTitle);

        const scribeNotes = document.createElement('div');
        scribeNotes.style = 'white-space:pre-wrap';
        const ta = section.querySelector('textarea');
        scribeNotes.textContent = ta ? ta.value : '';
        reportProgress.appendChild(scribeNotes);

        uniqueQuestions.forEach(questionName => {
          const options = section.querySelectorAll(`input[name="${questionName}"]`);
          const selectedOption = document.querySelector(`#questionsContainer input[name="${questionName}"]:checked`);
          const questionScore = document.createElement('li');

          if (selectedOption) {
            if (selectedOption.hasAttribute('data-quiz')) {
              if (selectedOption.getAttribute('data-quiz') === selectedOption.value) {
                totalScore += 100;
                questionScore.innerHTML = `${qList[questionName]}: <strong>${escapeHTML(selectedOption.value)}</strong> <em>(CORRECT)</em>`;
              } else {
                questionScore.innerHTML = `${qList[questionName]}: <strong>${escapeHTML(selectedOption.value)}</strong> <em>(INCORRECT — correct: "${escapeHTML(selectedOption.getAttribute('data-quiz'))}")</em>`;
              }
            } else {
              const selectedIndex = Array.from(options).indexOf(selectedOption) + 1;
              const score = ((selectedIndex - 1) / (options.length - 1)) * 100;
              totalScore += score;
              questionScore.innerHTML = `${qList[questionName]}: <strong>${escapeHTML(selectedOption.value)}</strong> (${score.toFixed(0)}% indicative)`;
            }
            answeredQuestions++;
          } else {
            questionScore.innerHTML = `${qList[questionName]}: <strong>Not Answered</strong>`;
          }
          sectionProgress.appendChild(questionScore);
        });

        if (answeredQuestions > 0) {
          let sScore = answeredQuestions > 0 ? (totalScore / answeredQuestions).toFixed(0) : 0;
          if (uniqueQuestions.length === 0) sScore = 100;
          const isFullyAnswered = answeredQuestions === uniqueQuestions.length;
          completion = completion && isFullyAnswered;
          if (isFullyAnswered) {
            const m = document.getElementById('marker' + tick);
            if (m) m.classList.add('complete');
            const r = document.getElementById('round' + tick);
            if (r) r.classList.add('complete');
          }
          totalSectionScores += parseFloat(totalScore);
          totalSections += answeredQuestions;

          const sectionOverall = document.createElement('p');
          sectionOverall.innerHTML = `<strong>Stage ${tick} ("${sectionName}"): ${sScore}%</strong> (${formatTime(stageTime[tick] || 0)} — ${isFullyAnswered ? 'Complete' : 'Incomplete'})`;
          sectionProgress.prepend(sectionOverall);
          SectionScores.push({ name: 'Stage ' + tick, value: Number(sScore), time: Number(stageTime[tick] || 0) });
          progressDiv.appendChild(sectionProgress);
          reportProgress.appendChild(sectionProgress.cloneNode(true));
          reportDiv.appendChild(reportProgress);
        } else {
          if (ta && ta.value) reportDiv.appendChild(reportProgress);
          SectionScores.push({ name: 'Stage ' + tick, value: null, time: Number(stageTime[tick] || 0) });
        }
      });

      if (completion) exerciseComplete = true;
      const overallFormScore = totalSections > 0 ? (totalSectionScores / totalSections).toFixed(0) : 0;
      overallScore = `Exercise Summary (Indicative Score: ${overallFormScore}%)`;
      return SectionScores;
    }

    /* =============================================
       CHARTS
       ============================================= */
    function generateCharts(data) {
      const outer = document.createElement('div');
      outer.className = 'outer';
      const container = document.createElement('div');
      container.className = 'chart-container';

      const barTitle = document.createElement('h3');
      barTitle.textContent = 'Score by Stage';
      barTitle.style.textAlign = 'center';
      container.appendChild(barTitle);
      container.appendChild(barchart(data));
      container.appendChild(donutchart(data));

      const donutTitle = document.createElement('h3');
      donutTitle.textContent = 'Duration by Stage';
      donutTitle.style.textAlign = 'center';
      container.appendChild(donutTitle);

      outer.appendChild(container);
      return outer.outerHTML;
    }

    function generateDistinctColorVariations(baseHue, numVariants) {
      const colors = [];
      let sat = 40, lgt = 40;
      for (let i = 0; i < numVariants; i++) {
        colors.push(`hsl(${baseHue},${Math.max(40, sat)}%,${Math.min(80, Math.max(40, lgt))}%)`);
        if (i % 2 === 0) sat = (sat + 40) % 100;
        else lgt = (lgt + 30) % 100;
      }
      return colors;
    }

    function barchart(data) {
      const colors = generateDistinctColorVariations(200, data.length);
      const chart = document.createElement('div');
      chart.className = 'bchart';
      data.forEach((item, i) => {
        if (item.value === null) return;
        const bar = document.createElement('div');
        bar.className = 'bar';
        const inner = document.createElement('div');
        inner.className = 'bar-inner';
        // Use percentage of the bar's height so it scales with em-based container
        const pct = Math.max(3, Math.round(item.value)) + '%';
        inner.style.height = pct;
        inner.style.background = colors[i];
        const lbl = document.createElement('div');
        lbl.className = 'bar-label';
        lbl.textContent = item.value + '%';
        const axis = document.createElement('div');
        axis.className = 'x-axis-label';
        axis.textContent = item.name;
        inner.appendChild(lbl);
        bar.appendChild(inner);
        bar.appendChild(axis);
        chart.appendChild(bar);
      });
      return chart;
    }

    function donutchart(inputData) {
      const colors = generateDistinctColorVariations(200, inputData.length);
      const total = inputData.reduce((s, i) => s + (i.time || 0), 0);
      const chart = document.createElement('div');
      chart.className = 'dchart';
      inputData.forEach((item, i) => {
        const pct = total > 0 ? (item.time / total) * 100 : 0;
        const seg = document.createElement('div');
        seg.className = 'segment';
        seg.style.width = pct + '%';
        seg.style.background = colors[i % colors.length];
        seg.textContent = i + 1;
        chart.appendChild(seg);
      });
      return chart;
    }

    /* =============================================
       EXPORT
       ============================================= */
    function exportScenario() { serveFile(rawFileData, 'export.ttxf'); }

    function exportReport() {
      const Scores = updateProgress();
      let html = REPORT_HEADER.replace('%%REPORT_TITLE%%', 'Exercise Report');
      html += `<h2>${escapeHTML(start ? start.title : '')}</h2><p>${new Date().toLocaleDateString()}</p>`;
      html += (start && start.content) ? `<div>${start.content}</div>` : '';
      html += `<h2>${overallScore}</h2>`;
      html += generateCharts(Scores);
      html += reportDiv.innerHTML;
      html += REPORT_FOOTER;
      serveFile(html, 'exercise-report.html');
    }

    function serveFile(text, downloadAs) {
      const blob = new Blob([text], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      if (downloadAs) a.download = downloadAs;
      else a.target = '_blank';
      a.href = url;
      a.style.display = 'none';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 5000);
    }

    /* =============================================
       FULLSCREEN
       ============================================= */
    function toggleFullscreen() {
      const doc = window.document, el = doc.documentElement;
      const req = el.requestFullscreen || el.mozRequestFullScreen || el.webkitRequestFullScreen || el.msRequestFullscreen;
      const exit = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;
      if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement)
        req.call(el);
      else exit.call(doc);
    }

    /* =============================================
       LAUNCH PRESENTATION
       ============================================= */
    function launchPresentation() {
      serveFile(PRESENTATION_HTML);
      setTimeout(() => { nextStage(); previousStage(); }, 750);
    }

    /* =============================================
       RESET
       ============================================= */
    function resetExercise() {
      stageTime = []; questionCounter = 0; roundCounter = 0; ActiveStage = 0;
      fileName = fileContent = data = null; timer = false; exerciseComplete = false;
      qList = []; rawFileData = ''; firsttimer = 0;
      clearInterval(timerInterval); timerInterval = null;
      document.getElementById('questionsContainer').innerHTML = '';
      document.getElementById('stageWrapper').innerHTML = '';
      document.getElementById('times').innerHTML = '';
      document.getElementById('scenario-loader-data').innerHTML = '';
      document.getElementById('title-text').innerHTML = '';
    }

    /* =============================================
       CONFIG PARSER
       ============================================= */
    function parseConfigToJSON(configString) {
      const lines = configString.split(/\r?\n/);
      const json = { stages: [] };
      let currentKey = null, currentQuestion = null, currentStage = null;
      let currentArrayContext = null, multiLineKey = null, multiLineValue = '';
      const MAX_ML = 10000;
      const PARSE_ERRORS = [];

      lines.forEach((line, lineNum) => {
        if (line.trim().startsWith('//')) return;
        const t = line.trim();

        // Flush multiline if new directive starts
        if (multiLineKey && (t.startsWith('! ') || t.startsWith('# ') || t.startsWith('? ') || t.startsWith('@ ') || t.startsWith('+ '))) {
          const target = currentStage || json;
          target[multiLineKey] = processMarkdown(multiLineValue.trim());
          multiLineKey = null; multiLineValue = '';
        }

        if (t.startsWith('! ')) {
          const rest = t.slice(2);
          const colonIdx = rest.indexOf(':');
          if (colonIdx > -1) {
            const key = rest.slice(0, colonIdx).trim();
            const value = rest.slice(colonIdx + 1).trim();
            (currentStage || json)[key] = escapeHTML(value);
          } else {
            multiLineKey = rest.trim(); multiLineValue = '';
          }
          currentKey = null; currentQuestion = null; currentArrayContext = null;

        } else if (t.startsWith('# ')) {
          currentKey = t.slice(2).trim();
          (currentStage || json)[currentKey] = [];
          currentQuestion = null; currentArrayContext = currentKey;

        } else if (t.startsWith('? ')) {
          const qText = t.slice(2).trim();
          currentQuestion = { question: escapeHTML(qText), answers: [] };
          if (!currentStage) json.questions = json.questions || [];
          else currentStage.questions = currentStage.questions || [];
          (currentStage ? currentStage.questions : json.questions).push(currentQuestion);
          currentKey = null; currentArrayContext = null;

        } else if (t.startsWith('@ ')) {
          const stageName = t.slice(2).trim();
          currentStage = { stage: escapeHTML(stageName) };
          json.stages.push(currentStage);
          currentKey = null; currentQuestion = null; currentArrayContext = null;

        } else if (t.startsWith('++ ')) {
          if (currentQuestion) {
            const answer = t.slice(3).trim();
            currentQuestion.answers.push(answer);
            currentQuestion.quiz = answer;
          }

        } else if (t.startsWith('+ ')) {
          const itemText = t.slice(2).trim();
          if (currentArrayContext) {
            const arr = currentStage ? currentStage[currentArrayContext] : json[currentArrayContext];
            if (Array.isArray(arr)) arr.push(itemText);
          } else if (currentQuestion) {
            currentQuestion.answers.push(itemText);
          }

        } else if (multiLineKey) {
          if (multiLineValue.length + t.length <= MAX_ML) multiLineValue += t + '\n';
        }
      });

      // Flush remaining multiline
      if (multiLineKey) {
        (currentStage || json)[multiLineKey] = processMarkdown(multiLineValue.trim());
      }

      return json;
    }

    function processMarkdown(text) {
      let result = '';
      const paragraphs = text.split(/\n\n+/);
      paragraphs.forEach(para => {
        let processed = escapeHTML(para.trim());
        processed = processed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        processed = processed.replace(/\*(.*?)\*/g, '<em>$1</em>');
        processed = processed.replace(/%\((.*?)\)/g, '<img class="SFmedia" src="$1" alt="">');

        let bulletItems = [], numberedItems = [];
        const lines = processed.split('\n');
        lines.forEach(ln => {
          if (/^\s*-\s+(.*)$/.test(ln)) {
            bulletItems.push(ln.replace(/^\s*-\s+/, ''));
          } else if (/^\s*\d+\.\s+(.*)$/.test(ln)) {
            numberedItems.push(ln.replace(/^\s*\d+\.\s+/, ''));
          } else {
            if (bulletItems.length) { result += '<ul>' + bulletItems.map(i => `<li>${i}</li>`).join('') + '</ul>'; bulletItems = []; }
            if (numberedItems.length) { result += '<ol>' + numberedItems.map(i => `<li>${i}</li>`).join('') + '</ol>'; numberedItems = []; }
            result += `<p>${ln}</p>`;
          }
        });
        if (bulletItems.length) result += '<ul>' + bulletItems.map(i => `<li>${i}</li>`).join('') + '</ul>';
        if (numberedItems.length) result += '<ol>' + numberedItems.map(i => `<li>${i}</li>`).join('') + '</ol>';
      });
      result = result.replace(/<p>~(.*?)<\/p>/g, '<blockquote>$1</blockquote>');
      return result;
    }

    function escapeHTML(unsafe) {
      if (typeof unsafe !== 'string') return '';
      return unsafe.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
  </script>
</body>

</html>